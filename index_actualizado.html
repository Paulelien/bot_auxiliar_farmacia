<!DOCTYPE html>
<!-- √öltima actualizaci√≥n: 2024-12-19 15:30 - Forzar actualizaci√≥n LMS -->
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Asistente Virtual de Farmacia - Avanxa - VERSION ACTUALIZADA 15:30</title>
    <style>
        :root {
            --color-primario: #4B2067;
            --color-secundario: #7C3FAF;
            --color-acento: #FF6B35;
            --color-texto: #2C3E50;
            --color-fondo: #F8F9FA;
            --color-rojo: #FF0000;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: #F8F9FA;
            min-height: 100vh;
            color: var(--color-texto);
            line-height: 1.6;
        }

        .container {
            max-width: 1000px;
            margin: 0 auto;
            padding: 20px;
        }

        /* Secci√≥n del Asistente Virtual */
        .assistant-intro {
            background: white;
            border-radius: 12px;
            padding: 2rem;
            margin-bottom: 2rem;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            border: 1px solid #E9ECEF;
        }

        .assistant-intro p {
            font-size: 1.1rem;
            color: var(--color-texto);
            text-align: center;
            margin-bottom: 0;
        }

        /* Chat Interface */
        .chat-interface {
            background: white;
            border-radius: 12px;
            padding: 2rem;
            margin-bottom: 2rem;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            border: 1px solid #E9ECEF;
        }

        .chat-window {
            background: #F8F9FA;
            border-radius: 12px;
            padding: 1.5rem;
            border: 1px solid #E9ECEF;
            min-height: 200px;
            margin-bottom: 1.5rem;
            position: relative;
        }

        .chat-message {
            display: flex;
            justify-content: flex-end;
            margin-bottom: 1rem;
        }

        .chat-bubble {
            background: var(--color-secundario);
            color: white;
            padding: 1rem 1.5rem;
            border-radius: 20px;
            max-width: 70%;
            position: relative;
            margin-left: auto;
        }

        .chat-bubble::before {
            content: '';
            position: absolute;
            right: -10px;
            top: 50%;
            transform: translateY(-50%);
            width: 0;
            height: 0;
            border-left: 10px solid var(--color-secundario);
            border-top: 8px solid transparent;
            border-bottom: 8px solid transparent;
        }

        .chat-bubble.user-bubble::before {
            right: auto;
            left: -10px;
            border-left: none;
            border-right: 10px solid #E8F5E8;
        }

        .chat-input-container {
            display: flex;
            gap: 1rem;
            align-items: center;
        }

        .chat-input-field {
            flex: 1;
            padding: 1rem 1.5rem;
            border: 1px solid #E9ECEF;
            border-radius: 25px;
            font-size: 16px;
            background: white;
        }

        .chat-input-field:focus {
            outline: none;
            border-color: var(--color-secundario);
        }

        .btn-send {
            background: var(--color-primario);
            color: white;
            border: none;
            border-radius: 25px;
            padding: 1rem 2rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .btn-send:hover {
            background: var(--color-secundario);
        }

        .chat-actions {
            display: flex;
            gap: 0.5rem;
        }

        .btn-action {
            background: none;
            border: none;
            padding: 0.5rem;
            cursor: pointer;
            border-radius: 50%;
            transition: background 0.3s ease;
        }

        .btn-action:hover {
            background: #E9ECEF;
        }

        .btn-action i {
            font-size: 1.2rem;
            color: #666;
        }

        /* Secci√≥n de Casos Cl√≠nicos */
        .clinical-cases-section {
            background: white;
            border-radius: 12px;
            padding: 2rem;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            border: 1px solid #E9ECEF;
        }

        .case-header {
            display: flex;
            align-items: center;
            margin-bottom: 1.5rem;
        }

        .case-icon {
            background: var(--color-rojo);
            color: white;
            width: 40px;
            height: 40px;
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.5rem;
            font-weight: bold;
            margin-right: 1rem;
        }

        .case-title {
            font-size: 1.5rem;
            font-weight: 600;
            color: var(--color-texto);
        }

        .case-description {
            color: var(--color-texto);
            margin-bottom: 2rem;
            line-height: 1.7;
        }

        .btn-start-practice {
            background: var(--color-primario);
            color: white;
            border: none;
            border-radius: 8px;
            padding: 1rem 2rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            margin-right: 1rem;
        }

        .btn-start-practice:hover {
            background: var(--color-secundario);
        }

        .case-actions {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .case-controls {
            display: flex;
            gap: 0.5rem;
        }

        .btn-control {
            background: none;
            border: none;
            padding: 0.5rem;
            cursor: pointer;
            border-radius: 50%;
            transition: background 0.3s ease;
        }

        .btn-control:hover {
            background: #E9ECEF;
        }

        .btn-control i {
            font-size: 1.2rem;
            color: #666;
        }

        /* Responsive */
        @media (max-width: 768px) {
            .container {
                padding: 10px;
            }
            
            .chat-input-container {
                flex-direction: column;
                gap: 0.5rem;
            }
            
            .chat-actions {
                justify-content: center;
            }
            
            .case-actions {
                flex-direction: column;
                gap: 1rem;
                align-items: stretch;
            }
        }
    </style>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
</head>
<body>
    <div class="container">
        <!-- Secci√≥n del Asistente Virtual -->
        <div class="assistant-intro">
            <p>¬°Hola! Soy XXXXXXXXX, tu Asistente Virtual de Farmacia. Estoy aqu√≠ para ayudarte con tus dudas sobre el curso de Auxiliar de Farmacia. Puedes escribirme cualquier pregunta o elegir una de las sugerencias que aparecen m√°s abajo. ¬°Comencemos!</p>
        </div>

        <!-- Interfaz de Chat -->
        <div class="chat-interface">
            <div class="chat-window" id="chatWindow">
                <div class="chat-message">
                    <div class="chat-bubble">
                        <strong>Asistente educativo:</strong> ¬°Hola! ¬øEn qu√© puedo ayudarte hoy?
                    </div>
                </div>
            </div>
            
            <div class="chat-input-container">
                <button class="btn-send" onclick="sendQuestion()" id="sendBtn">Enviar</button>
                <input type="text" id="questionInput" class="chat-input-field" placeholder="Escribe tu pregunta aqu√≠" onkeypress="handleKeyPress(event)">
                <div class="chat-actions">
                    <button class="btn-action" onclick="clearChat()" title="Limpiar chat">
                        <i class="fas fa-trash"></i>
                    </button>
                    <button class="btn-action" onclick="exportChat()" title="Exportar chat">
                        <i class="fas fa-file-export"></i>
                    </button>
                </div>
            </div>
        </div>

        <!-- Secci√≥n de Casos Cl√≠nicos -->
        <div class="clinical-cases-section">
            <div class="case-header">
                <div class="case-icon">+</div>
                <div class="case-title">Practica con Casos Cl√≠nicos</div>
            </div>
            
            <div class="case-description">
                ¬°Prep√°rate para tu examen con casos cl√≠nicos reales! Practica en un entorno seguro y sin repercusiones negativas, dise√±ado para ayudarte a ensayar y reforzar tus conocimientos. Esta herramienta te permitir√° familiarizarte con el tipo de preguntas que podr√≠as enfrentar en el examen de competencia ante la SEREMI de Salud. ¬°Aumenta tu confianza y asegura tu √©xito!
            </div>
            
            <div class="case-actions">
                <button class="btn-start-practice" onclick="startCasosClinicos()">Iniciar Practica</button>
                <div class="case-controls">
                    <button class="btn-control" onclick="refreshCases()" title="Recargar">
                        <i class="fas fa-redo"></i>
                    </button>
                    <button class="btn-control" onclick="shuffleCases()" title="Mezclar">
                        <i class="fas fa-random"></i>
                    </button>
                </div>
            </div>
        </div>

        <!-- Contenido de Casos Cl√≠nicos (oculto inicialmente) -->
        <div id="quizContent" style="display: none;"></div>
    </div>

    <script>
        // CASOS CL√çNICOS INTEGRADOS DIRECTAMENTE - TODOS LOS CASOS
        const CASOS_CLINICOS = {
            "casos_clinicos": [
                {
                    "id": 1,
                    "titulo": "Caso Cl√≠nico: Paciente con Hipertensi√≥n",
                    "descripcion": "Mar√≠a, 65 a√±os, acude a la farmacia con una receta m√©dica para tratar su hipertensi√≥n arterial. Presenta presi√≥n arterial de 160/95 mmHg y tiene antecedentes de diabetes tipo 2.",
                    "preguntas": [
                        {
                            "id": 1,
                            "pregunta": "¬øCu√°l de los siguientes medicamentos NO es un antihipertensivo de primera l√≠nea?",
                            "opciones": [
                                "A) Losart√°n",
                                "B) Amlodipino", 
                                "C) Paracetamol",
                                "D) Enalapril"
                            ],
                            "respuesta_correcta": 2,
                            "explicacion": "El paracetamol es un analg√©sico y antipir√©tico, no un antihipertensivo. Los otros tres son medicamentos antihipertensivos comunes."
                        },
                        {
                            "id": 2,
                            "pregunta": "¬øQu√© precauci√≥n especial debe tener Mar√≠a al tomar antihipertensivos?",
                            "opciones": [
                                "A) Tomar con el est√≥mago lleno",
                                "B) Evitar cambios bruscos de posici√≥n",
                                "C) Exponerse al sol sin protecci√≥n",
                                "D) Hacer ejercicio intenso inmediatamente"
                            ],
                            "respuesta_correcta": 1,
                            "explicacion": "Los antihipertensivos pueden causar hipotensi√≥n ortost√°tica, por lo que se debe evitar levantarse bruscamente."
                        },
                        {
                            "id": 3,
                            "pregunta": "¬øCu√°l es el valor normal de presi√≥n arterial para adultos?",
                            "opciones": [
                                "A) 140/90 mmHg",
                                "B) 120/80 mmHg",
                                "C) 160/100 mmHg", 
                                "D) 180/110 mmHg"
                            ],
                            "respuesta_correcta": 1,
                            "explicacion": "El valor normal de presi√≥n arterial es menor a 120/80 mmHg."
                        },
                        {
                            "id": 4,
                            "pregunta": "¬øQu√© efecto secundario es com√∫n en los inhibidores de la ECA?",
                            "opciones": [
                                "A) Tos seca",
                                "B) Diarrea",
                                "C) Insomnio",
                                "D) P√©rdida de apetito"
                            ],
                            "respuesta_correcta": 0,
                            "explicacion": "La tos seca es un efecto secundario frecuente de los inhibidores de la ECA como el enalapril."
                        },
                        {
                            "id": 5,
                            "pregunta": "¬øQu√© recomendaci√≥n diet√©tica es importante para Mar√≠a?",
                            "opciones": [
                                "A) Aumentar el consumo de sal",
                                "B) Reducir el consumo de sodio",
                                "C) Consumir m√°s grasas saturadas",
                                "D) Evitar las verduras"
                            ],
                            "respuesta_correcta": 1,
                            "explicacion": "La reducci√≥n del consumo de sodio es fundamental en el tratamiento de la hipertensi√≥n arterial."
                        }
                    ]
                },
                {
                    "id": 2,
                    "titulo": "Caso Cl√≠nico: Paciente con Diabetes",
                    "descripcion": "Carlos, 45 a√±os, diagnosticado recientemente con diabetes tipo 2. Acude a la farmacia para recibir orientaci√≥n sobre su medicaci√≥n y cuidados generales.",
                    "preguntas": [
                        {
                            "id": 1,
                            "pregunta": "¬øCu√°l es el objetivo principal del tratamiento de la diabetes tipo 2?",
                            "opciones": [
                                "A) Curar la enfermedad",
                                "B) Mantener niveles normales de glucosa",
                                "C) Eliminar la insulina del cuerpo",
                                "D) Reducir el peso corporal √∫nicamente"
                            ],
                            "respuesta_correcta": 1,
                            "explicacion": "El objetivo principal es mantener niveles normales de glucosa en sangre para prevenir complicaciones."
                        },
                        {
                            "id": 2,
                            "pregunta": "¬øQu√© medicamento oral es de primera l√≠nea para la diabetes tipo 2?",
                            "opciones": [
                                "A) Insulina",
                                "B) Metformina",
                                "C) Glibenclamida",
                                "D) Pioglitazona"
                            ],
                            "respuesta_correcta": 1,
                            "explicacion": "La metformina es el medicamento de primera l√≠nea para el tratamiento de la diabetes tipo 2."
                        },
                        {
                            "id": 3,
                            "pregunta": "¬øCu√°l es el valor normal de glucosa en ayunas?",
                            "opciones": [
                                "A) 70-100 mg/dL",
                                "B) 100-126 mg/dL",
                                "C) 126-200 mg/dL",
                                "D) M√°s de 200 mg/dL"
                            ],
                            "respuesta_correcta": 0,
                            "explicacion": "Los valores normales de glucosa en ayunas son entre 70-100 mg/dL."
                        },
                        {
                            "id": 4,
                            "pregunta": "¬øQu√© complicaci√≥n es m√°s frecuente en pacientes diab√©ticos?",
                            "opciones": [
                                "A) Problemas card√≠acos",
                                "B) Problemas renales",
                                "C) Problemas oculares",
                                "D) Todas las anteriores"
                            ],
                            "respuesta_correcta": 3,
                            "explicacion": "La diabetes puede afectar m√∫ltiples √≥rganos, siendo frecuentes las complicaciones card√≠acas, renales y oculares."
                        },
                        {
                            "id": 5,
                            "pregunta": "¬øQu√© recomendaci√≥n es importante para el autocontrol de la diabetes?",
                            "opciones": [
                                "A) Medir glucosa solo cuando se sienta mal",
                                "B) Realizar controles regulares de glucosa",
                                "C) No medir nunca la glucosa",
                                "D) Medir solo una vez al mes"
                            ],
                            "respuesta_correcta": 1,
                            "explicacion": "El autocontrol regular de la glucosa es fundamental para el manejo adecuado de la diabetes."
                        }
                    ]
                },
                {
                    "id": 3,
                    "titulo": "Caso Cl√≠nico: Paciente con Dolor Cr√≥nico",
                    "descripcion": "Ana, 58 a√±os, padece artritis reumatoide y acude a la farmacia con dolor cr√≥nico en las articulaciones. Toma medicamentos antiinflamatorios regularmente.",
                    "preguntas": [
                        {
                            "id": 1,
                            "pregunta": "¬øQu√© tipo de medicamento es m√°s apropiado para el dolor cr√≥nico de Ana?",
                            "opciones": [
                                "A) Paracetamol",
                                "B) Ibuprofeno",
                                "C) Morfina",
                                "D) Aspirina"
                            ],
                            "respuesta_correcta": 1,
                            "explicacion": "Los antiinflamatorios no esteroideos como el ibuprofeno son apropiados para el dolor inflamatorio cr√≥nico."
                        },
                        {
                            "id": 2,
                            "pregunta": "¬øQu√© efecto secundario es com√∫n en los AINEs?",
                            "opciones": [
                                "A) Problemas gastrointestinales",
                                "B) Somnolencia",
                                "C) P√©rdida de memoria",
                                "D) Visi√≥n borrosa"
                            ],
                            "respuesta_correcta": 0,
                            "explicacion": "Los AINEs pueden causar irritaci√≥n g√°strica y √∫lceras, por lo que deben tomarse con alimentos."
                        },

                        {
                            "id": 3,
                            "pregunta": "¬øQu√© recomendaci√≥n es importante para Ana?",
                            "opciones": [
                                "A) Tomar medicamentos con el est√≥mago vac√≠o",
                                "B) Tomar medicamentos con alimentos",
                                "C) No hacer ejercicio",
                                "D) Evitar el reposo"
                            ],
                            "respuesta_correcta": 1,
                            "explicacion": "Los AINEs deben tomarse con alimentos para reducir la irritaci√≥n g√°strica."
                        },
                        {
                            "id": 4,
                            "pregunta": "¬øQu√© terapia complementaria puede ayudar a Ana?",
                            "opciones": [
                                "A) Fisioterapia",
                                "B) Acupuntura",
                                "C) Ejercicio moderado",
                                "D) Todas las anteriores"
                            ],
                            "respuesta_correcta": 3,
                            "explicacion": "Todas estas terapias complementarias pueden ayudar en el manejo del dolor cr√≥nico."
                        }
                    ]
                },
                {
                    "id": 4,
                    "titulo": "Caso Cl√≠nico: Paciente Pedi√°trico",
                    "descripcion": "Lucas, 8 a√±os, presenta fiebre de 38.5¬∞C y dolor de garganta. Su madre acude a la farmacia buscando orientaci√≥n sobre el tratamiento adecuado.",
                    "preguntas": [
                        {
                            "id": 1,
                            "pregunta": "¬øQu√© medicamento es seguro para la fiebre en ni√±os?",
                            "opciones": [
                                "A) Aspirina",
                                "B) Paracetamol",
                                "C) Ibuprofeno",
                                "D) B y C son correctas"
                            ],
                            "respuesta_correcta": 3,
                            "explicacion": "Tanto el paracetamol como el ibuprofeno son seguros para ni√±os, pero nunca aspirina por riesgo de s√≠ndrome de Reye."
                        },

                        {
                            "id": 2,
                            "pregunta": "¬øCu√°ndo se debe derivar al m√©dico un ni√±o con fiebre?",
                            "opciones": [
                                "A) Siempre que tenga fiebre",
                                "B) Si la fiebre persiste m√°s de 3 d√≠as",
                                "C) Solo si la fiebre es muy alta",
                                "D) Nunca es necesario"
                            ],
                            "respuesta_correcta": 1,
                            "explicacion": "Se debe derivar al m√©dico si la fiebre persiste m√°s de 3 d√≠as o si hay otros s√≠ntomas preocupantes."
                        },
                        {
                            "id": 3,
                            "pregunta": "¬øQu√© medida no farmacol√≥gica es √∫til para la fiebre?",
                            "opciones": [
                                "A) Ba√±os con agua fr√≠a",
                                "B) Ba√±os con agua tibia",
                                "C) Abrigar mucho al ni√±o",
                                "D) No dar l√≠quidos"
                            ],
                            "respuesta_correcta": 1,
                            "explicacion": "Los ba√±os con agua tibia ayudan a bajar la fiebre de forma segura."
                        },
                        {
                            "id": 4,
                            "pregunta": "¬øQu√© es importante verificar antes de administrar medicamentos a ni√±os?",
                            "opciones": [
                                "A) Solo el peso",
                                "B) Solo la edad",
                                "C) Peso, edad y antecedentes al√©rgicos",
                                "D) Solo si tiene hambre"
                            ],
                            "respuesta_correcta": 2,
                            "explicacion": "Es fundamental verificar peso, edad y antecedentes al√©rgicos antes de administrar medicamentos a ni√±os."
                        }
                    ]
                },
                {
                    "id": 5,
                    "titulo": "Caso Cl√≠nico: Gesti√≥n de Almacenamiento de Vacunas e Insulina",
                    "descripcion": "Un auxiliar de farmacia recibe un nuevo lote de vacunas y jeringas precargadas de insulina. Estos productos requieren condiciones especiales de almacenamiento para mantener su calidad y eficacia.",
                    "preguntas": [
                        {
                            "id": 1,
                            "pregunta": "Considerando el vencimiento y la necesidad de cadena de fr√≠o, ¬øcu√°l de las siguientes combinaciones de principio de gesti√≥n de existencias y rango de temperatura es la m√°s adecuada para estos productos?",
                            "opciones": [
                                "A) FIFO (First In, First Out) a 15-25¬∞C",
                                "B) LIFO (Last In, First Out) a 8-15¬∞C", 
                                "C) FEFO (First Expired, First Out) a 2-8¬∞C",
                                "D) FSN (Fast, Slow, Non-moving) a menos de 0¬∞C"
                            ],
                            "respuesta_correcta": 2,
                            "explicacion": "La alternativa correcta es c) FEFO (First Expired, First Out) a 2-8¬∞C. El principio FEFO, acr√≥nimo en ingl√©s de \"First Expired, First Out\", es fundamental para el auxiliar de farmacia y rige la norma 147. Este principio prioriza la salida de los productos cuya fecha de caducidad est√° m√°s pr√≥xima, independientemente del lote, lo cual ayuda a prevenir p√©rdidas por vencimiento. Tanto las vacunas como las insulinas son productos que requieren mantener una cadena de fr√≠o estricta, lo que significa que deben conservarse a una temperatura entre 2 y 8¬∞C. Es importante recordar que la insulina NUNCA debe ser congelada."
                        }
                    ]
                },
                {
                    "id": 6,
                    "titulo": "Caso Cl√≠nico: C√°lculo Posol√≥gico - √Åcido Valproico Gotas",
                    "descripcion": "Un paciente acude a la farmacia con una receta para √Åcido Valproico Gotas. La indicaci√≥n m√©dica es \"administrar 23 gotas cada 12 horas por 3 meses\". La farmacia solo dispone de √Åcido Valproico en una presentaci√≥n de frascos de 25 mL, y se sabe que 20 gotas equivalen a 1 mL.",
                    "preguntas": [
                        {
                            "id": 1,
                            "pregunta": "¬øCu√°ntos frascos de 25 mL de √Åcido Valproico Gotas deber√≠a dispensar el auxiliar de farmacia para cubrir el tratamiento completo de este paciente?",
                            "opciones": [
                                "A) 8 frascos",
                                "B) 9 frascos",
                                "C) 10 frascos", 
                                "D) 4 frascos"
                            ],
                            "respuesta_correcta": 1,
                            "explicacion": "La alternativa correcta es b) 9 frascos. Para determinar la cantidad de frascos a dispensar, se realizan los siguientes c√°lculos posol√≥gicos: 1. Calcular la dosis diaria en gotas: La indicaci√≥n \"cada 12 horas\" implica 2 administraciones al d√≠a (24 horas / 12 horas = 2). Por lo tanto, 23 gotas * 2 veces al d√≠a = 46 gotas diarias. 2. Calcular el total de gotas para el tratamiento: El tratamiento es por 3 meses, lo que se considera como 90 d√≠as. Entonces, 46 gotas/d√≠a * 90 d√≠as = 4.140 gotas necesarias para el tratamiento. 3. Determinar cu√°ntas gotas contiene un frasco de 25 mL: Sabiendo que 20 gotas equivalen a 1 mL, un frasco de 25 mL contiene 25 mL * 20 gotas/mL = 500 gotas por frasco. 4. Calcular el n√∫mero de frascos necesarios: Se divide el total de gotas requeridas por el n√∫mero de gotas por frasco: 4.140 gotas / 500 gotas/frasco = 8,28 frascos. 5. Dado que no es posible dispensar frascos fraccionados y se debe asegurar la indemnidad del producto terminado y el cumplimiento completo del tratamiento, se debe redondear al entero superior. Por lo tanto, el auxiliar deber√° dispensar 9 frascos al paciente."
                        }
                    ]
                },
                {
                    "id": 7,
                    "titulo": "Caso Cl√≠nico: Despacho de Medicamentos Estupefacientes",
                    "descripcion": "Un paciente presenta una receta para un medicamento clasificado como estupefaciente. En ese momento, el Qu√≠mico Farmac√©utico (Director T√©cnico) no se encuentra en el establecimiento, y el Auxiliar de Farmacia es el √∫nico personal presente con autorizaci√≥n para despachar otros tipos de recetas y manejar el abastecimiento.",
                    "preguntas": [
                        {
                            "id": 1,
                            "pregunta": "Seg√∫n el Reglamento 466, ¬øcu√°l es la acci√≥n correcta que debe tomar el Auxiliar de Farmacia en esta situaci√≥n?",
                            "opciones": [
                                "A) Despachar la receta, haciendo constar su nombre y firma, ya que tiene autorizaci√≥n sanitaria para el despacho de productos farmac√©uticos en general.",
                                "B) Negarse a despachar la receta y pedir al paciente que espere al Qu√≠mico Farmac√©utico, ya que el despacho de este tipo de medicamentos es una responsabilidad exclusiva de este √∫ltimo.",
                                "C) Informar al paciente que la farmacia no comercializa este tipo de medicamentos controlados.",
                                "D) Despachar la receta si cuenta con una autorizaci√≥n escrita del Qu√≠mico Farmac√©utico para acceder al √°rea de control de stock."
                            ],
                            "respuesta_correcta": 1,
                            "explicacion": "La alternativa correcta es b) Negarse a despachar la receta y pedir al paciente que espere al Qu√≠mico Farmac√©utico, ya que el despacho de este tipo de medicamentos es una responsabilidad exclusiva de este √∫ltimo. El Reglamento 466 establece claramente que es responsabilidad del Qu√≠mico Farmac√©utico (Director T√©cnico) despachar personalmente las recetas de productos farmac√©uticos sometidos a controles legales especiales, como estupefacientes y psicotr√≥picos, dejando constancia de su nombre y firma. Aunque el auxiliar de farmacia tiene responsabilidades en el despacho y manejo de productos farmac√©uticos bajo la supervisi√≥n del director t√©cnico, la funci√≥n espec√≠fica de despacho personal de sustancias controladas es atribuida al Qu√≠mico Farmac√©utico. El acceso al √°rea de control de stock de estos productos est√° restringido al director t√©cnico o personal autorizado por escrito por √©l, pero esto no delega la obligaci√≥n de \"despacho personal\" del Qu√≠mico Farmac√©utico."
                        }
                    ]
                },
                {
                    "id": 8,
                    "titulo": "Caso Cl√≠nico: Validez de Recetas Magistrales",
                    "descripcion": "Un paciente acude a una farmacia que cuenta con recetario magistral, presentando una receta para una f√≥rmula magistral (una crema t√≥pica personalizada) que fue extendida por su m√©dico hace 40 d√≠as. El auxiliar de farmacia debe verificar la validez de la receta antes de procesarla para su elaboraci√≥n.",
                    "preguntas": [
                        {
                            "id": 1,
                            "pregunta": "¬øCu√°l es el estado de la receta magistral presentada por el paciente, seg√∫n la normativa vigente?",
                            "opciones": [
                                "A) Es v√°lida, ya que las recetas magistrales, al ser personalizadas, no tienen un plazo de caducidad estricto.",
                                "B) Es v√°lida, siempre y cuando el m√©dico revalide la fecha en la farmacia mediante un nuevo documento o firma.",
                                "C) No es v√°lida, pues ha excedido el plazo legal de 30 d√≠as corridos desde su extensi√≥n.",
                                "D) Es v√°lida si el auxiliar de farmacia, tras evaluar al paciente, considera que el tratamiento sigue siendo pertinente."
                            ],
                            "respuesta_correcta": 2,
                            "explicacion": "La alternativa correcta es c) No es v√°lida, pues ha excedido el plazo legal de 30 d√≠as corridos desde su extensi√≥n. Los documentos indican que \"El plazo durante el cual una receta es v√°lida para ser presentada a su elaboraci√≥n en recetario es de 30 d√≠as corridos contados desde la fecha de su extensi√≥n\". Una vez superado este plazo, la receta pierde su validez para ser elaborada en el recetario, independientemente de la necesidad cl√≠nica o la valoraci√≥n del auxiliar."
                        }
                    ]
                },
                {
                    "id": 9,
                    "titulo": "Caso Cl√≠nico: Almacenamiento de Medicamentos Fotosensibles",
                    "descripcion": "El auxiliar de farmacia Pablo est√° realizando una revisi√≥n de las condiciones de almacenamiento en la sala de ventas. Observa que varios envases de medicamentos fotosensibles (que deben protegerse de la luz) est√°n ubicados cerca de un ventanal donde reciben luz solar directa durante varias horas al d√≠a. Adicionalmente, Pablo nota que los term√≥metros de m√°xima y m√≠nima no se han registrado por escrito en los √∫ltimos cinco d√≠as en las distintas √°reas de almacenamiento.",
                    "preguntas": [
                        {
                            "id": 1,
                            "pregunta": "¬øCu√°l de los siguientes factores de almacenamiento representa un riesgo inmediato para la calidad de los medicamentos fotosensibles observados y qu√© acci√≥n se requiere con respecto a la temperatura?",
                            "opciones": [
                                "A) La humedad, ya que promueve el crecimiento de bacterias y hongos en el producto.",
                                "B) La temperatura, aunque los medicamentos fotosensibles no se ven directamente afectados por ella.",
                                "C) La luz, que puede degradar los medicamentos, y el registro constante (al menos dos veces al d√≠a) y por escrito de la temperatura es obligatorio en todas las √°reas de almacenamiento.",
                                "D) La falta de segregaci√≥n f√≠sica de los productos, que puede llevar a contaminaci√≥n cruzada."
                            ],
                            "respuesta_correcta": 2,
                            "explicacion": "La alternativa correcta es c) La luz, que puede degradar los medicamentos, y el registro constante (al menos dos veces al d√≠a) y por escrito de la temperatura es obligatorio en todas las √°reas de almacenamiento."
                        }
                    ]
                }
            ]
        };

        // Variables globales para casos cl√≠nicos
        let casosClinicos = [];
        let casoActual = 0;
        let preguntaActual = 0;
        let puntajeCasosClinicos = 0;
        let totalPreguntasCasosClinicos = 0;
        let quizAnswered = false;

        // Funci√≥n para manejar Enter en el input
        function handleKeyPress(event) {
            if (event.key === 'Enter') {
                sendQuestion();
            }
        }

        // Funci√≥n para enviar pregunta (conectada con backend)
        async function sendQuestion() {
            const input = document.getElementById('questionInput');
            const question = input.value.trim();
            
            if (!question) {
                showError('Por favor, escribe una pregunta v√°lida.');
                return;
            }

            console.log('=== INICIO DE ENV√çO DE PREGUNTA ===');
            console.log('Pregunta a enviar:', question);

            // Agregar pregunta del usuario al chat
            addMessage('user', question);
            
            // Mostrar mensaje de carga
            const loadingMessage = addMessage('bot', 'ü§ñ El asistente est√° escribiendo...');
            
            try {
                // Conectar con tu API FastAPI
                const API_URL = 'https://asistente-auxiliar-farmacia.onrender.com';
                console.log('üîó Intentando conectar a:', API_URL);
                console.log('üìù Pregunta a enviar:', question);
                
                // Primero probar si la API est√° disponible
                console.log('üß™ Probando conexi√≥n b√°sica...');
                const testResponse = await fetch(`${API_URL}/`, {
                    method: 'GET',
                    mode: 'cors'
                });
                console.log('‚úÖ Test response status:', testResponse.status);
                
                console.log('üì§ Enviando pregunta al endpoint /preguntar...');
                const response = await fetch(`${API_URL}/preguntar`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    mode: 'cors',
                    body: JSON.stringify({
                        pregunta: question
                    })
                });
                
                console.log('üì• Response status:', response.status);
                console.log('üì• Response headers:', response.headers);
                
                if (!response.ok) {
                    throw new Error(`Error en la respuesta del servidor: ${response.status}`);
                }
                
                const data = await response.json();
                console.log('‚úÖ Response data recibida:', data);
                console.log('‚úÖ Respuesta del bot:', data.respuesta);
                
                // Remover mensaje de carga y mostrar respuesta real
                loadingMessage.remove();
                addMessage('bot', data.respuesta);
                console.log('‚úÖ Mensaje del bot agregado al chat');
                
            } catch (error) {
                console.error('‚ùå Error detallado:', error);
                console.error('‚ùå Error message:', error.message);
                console.error('‚ùå Error stack:', error.stack);
                loadingMessage.remove();
                addMessage('bot', 'Lo siento, hubo un error al procesar tu pregunta. Por favor, intenta de nuevo.');
                console.log('‚ùå Mensaje de error mostrado al usuario');
            }
            
            input.value = '';
            console.log('=== FIN DE ENV√çO DE PREGUNTA ===');
        }

        // Funci√≥n para agregar mensaje al chat
        function addMessage(type, content) {
            const chatWindow = document.getElementById('chatWindow');
            const messageDiv = document.createElement('div');
            messageDiv.className = 'chat-message';
            
            if (type === 'user') {
                // Mensaje del usuario (alineado a la izquierda)
                messageDiv.style.justifyContent = 'flex-start';
                messageDiv.innerHTML = `
                    <div class="chat-bubble user-bubble" style="background: #E8F5E8; color: #2C3E50; margin-left: 0; margin-right: auto;">
                        <strong>T√∫:</strong> ${content}
                    </div>
                `;
            } else {
                // Mensaje del bot (alineado a la derecha)
                messageDiv.innerHTML = `
                    <div class="chat-bubble">
                        <strong>Asistente educativo:</strong> ${content}
                    </div>
                `;
            }
            
            chatWindow.appendChild(messageDiv);
            chatWindow.scrollTop = chatWindow.scrollHeight;
            return messageDiv; // Retornar el elemento para poder eliminarlo despu√©s
        }

        // Funci√≥n para limpiar el chat
        function clearChat() {
            const chatWindow = document.getElementById('chatWindow');
            chatWindow.innerHTML = `
                <div class="chat-message">
                    <div class="chat-bubble">
                        <strong>Asistente educativo:</strong> ¬°Hola! ¬øEn qu√© puedo ayudarte hoy?
                    </div>
                </div>
            `;
        }

        // Funci√≥n para exportar el chat
        function exportChat() {
            const chatWindow = document.getElementById('chatWindow');
            const messages = chatWindow.querySelectorAll('.chat-bubble');
            let chatText = 'Conversaci√≥n con Asistente Virtual de Farmacia\n';
            chatText += 'Fecha: ' + new Date().toLocaleString() + '\n\n';
            
            messages.forEach(message => {
                chatText += message.textContent + '\n\n';
            });
            
            const blob = new Blob([chatText], { type: 'text/plain' });
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'chat_farmacia_' + new Date().toISOString().slice(0,10) + '.txt';
            a.click();
            window.URL.revokeObjectURL(url);
        }

        // Funci√≥n para recargar casos cl√≠nicos
        function refreshCases() {
            if (confirm('¬øDeseas recargar los casos cl√≠nicos?')) {
                location.reload();
            }
        }

        // Funci√≥n para mezclar casos cl√≠nicos
        function shuffleCases() {
            if (confirm('¬øDeseas mezclar el orden de los casos cl√≠nicos?')) {
                // Mezclar el array de casos cl√≠nicos
                for (let i = CASOS_CLINICOS.casos_clinicos.length - 1; i > 0; i--) {
                    const j = Math.floor(Math.random() * (i + 1));
                    [CASOS_CLINICOS.casos_clinicos[i], CASOS_CLINICOS.casos_clinicos[j]] = 
                    [CASOS_CLINICOS.casos_clinicos[j], CASOS_CLINICOS.casos_clinicos[i]];
                }
                alert('Casos cl√≠nicos mezclados correctamente.');
            }
        }

        // Funci√≥n para mostrar errores
        function showError(message) {
            const errorDiv = document.createElement('div');
            errorDiv.style.cssText = `
                background: #F44336;
                color: white;
                padding: 1rem;
                border-radius: 8px;
                margin: 1rem 0;
                text-align: center;
            `;
            errorDiv.textContent = message;
            document.querySelector('.chat-interface').insertBefore(errorDiv, document.querySelector('.chat-input-container'));
            
            setTimeout(() => {
                errorDiv.remove();
            }, 5000);
        }

        // Funci√≥n para iniciar casos cl√≠nicos
        function startCasosClinicos() {
            console.log('üöÄ Iniciando casos cl√≠nicos...');
            
            casosClinicos = CASOS_CLINICOS.casos_clinicos;
            casoActual = 0;
            preguntaActual = 0;
            puntajeCasosClinicos = 0;
            totalPreguntasCasosClinicos = casosClinicos.reduce((total, caso) => total + caso.preguntas.length, 0);
            quizAnswered = false; // Resetear estado de respuesta
            
            console.log(`‚úÖ Casos cl√≠nicos iniciados con ${casosClinicos.length} casos y ${totalPreguntasCasosClinicos} preguntas`);
            console.log('üìä Variables inicializadas:', {
                casosClinicos: casosClinicos.length,
                casoActual,
                preguntaActual,
                puntajeCasosClinicos,
                totalPreguntasCasosClinicos,
                quizAnswered
            });
            
            // Ocultar secciones principales y mostrar quiz
            document.querySelector('.assistant-intro').style.display = 'none';
            document.querySelector('.chat-interface').style.display = 'none';
            document.querySelector('.clinical-cases-section').style.display = 'none';
            document.getElementById('quizContent').style.display = 'block';
            
            console.log('üîÑ Llamando a showCasoClinico...');
            showCasoClinico();
        }

        // Funci√≥n para mostrar caso cl√≠nico
        function showCasoClinico() {
            const quizContent = document.getElementById('quizContent');
            
            if (casoActual >= casosClinicos.length) {
                // Mostrar resultados finales
                const porcentaje = Math.round((puntajeCasosClinicos / totalPreguntasCasosClinicos) * 100);
                let mensaje = '';
                if (porcentaje >= 90) {
                    mensaje = '¬°Excelente! üèÜ Dominas los casos cl√≠nicos';
                } else if (porcentaje >= 70) {
                    mensaje = '¬°Muy bien! üëç Buen manejo de casos cl√≠nicos';
                } else if (porcentaje >= 50) {
                    mensaje = '¬°Bien! üí™ Puedes mejorar en casos cl√≠nicos';
                } else {
                    mensaje = 'Necesitas repasar m√°s üìö los casos cl√≠nicos';
                }
                
                quizContent.innerHTML = `
                    <div class="quiz-question">¬°Evaluaci√≥n de Casos Cl√≠nicos Finalizada!</div>
                    <div class="success">
                        <h3>${mensaje}</h3>
                        <p>Tu puntaje: <b>${puntajeCasosClinicos} / ${totalPreguntasCasosClinicos}</b> (${porcentaje}%)</p>
                        <div class="progress-bar">
                            <div class="progress-fill" style="width: ${porcentaje}%"></div>
                        </div>
                        <p style="margin-top: 1rem; font-size: 0.9rem;">
                            üìä <strong>Resumen:</strong><br>
                            ‚Ä¢ Casos completados: ${casosClinicos.length}<br>
                            ‚Ä¢ Preguntas respondidas: ${totalPreguntasCasosClinicos}<br>
                            ‚Ä¢ Respuestas correctas: ${puntajeCasosClinicos}
                        </p>
                    </div>
                    <div style="text-align: center; margin-top: 2rem;">
                        <button class="btn" onclick="startCasosClinicos()" style="margin-right: 1rem;">üîÑ Reiniciar</button>
                        <button class="btn" onclick="resetQuizSection()">üè† Volver al Men√∫</button>
                    </div>
                `;
                return;
            }
            
            const caso = casosClinicos[casoActual];
            const pregunta = caso.preguntas[preguntaActual];
            
            // Calcular progreso general
            let preguntasCompletadas = 0;
            for (let i = 0; i < casoActual; i++) {
                preguntasCompletadas += casosClinicos[i].preguntas.length;
            }
            preguntasCompletadas += preguntaActual;
            const progreso = (preguntasCompletadas / totalPreguntasCasosClinicos) * 100;
            
            quizContent.innerHTML = `
                <div class="caso-clinico">
                    <div class="caso-titulo">${caso.titulo}</div>
                    <div class="caso-descripcion">${caso.descripcion}</div>
                </div>
                
                <div class="quiz-progress">
                    <div class="progress-text">
                        Caso ${casoActual + 1} de ${casosClinicos.length} - 
                        Pregunta ${preguntaActual + 1} de ${caso.preguntas.length}
                    </div>
                    <div class="progress-bar">
                        <div class="progress-fill" style="width: ${progreso}%"></div>
                    </div>
                    <div class="score-display">Puntaje actual: ${puntajeCasosClinicos}</div>
                </div>
                
                <div class="quiz-question">${pregunta.pregunta}</div>
                <div class="quiz-options">
                    ${pregunta.opciones.map((opcion, index) => `
                        <div class="quiz-option" onclick="selectOptionCasoClinico(this, ${index})">
                            ${opcion}
                        </div>
                    `).join('')}
                </div>
                <button class="btn" onclick="checkAnswerCasoClinico()" id="checkBtn" disabled>Responder</button>
            `;
        }

        // Funci√≥n para seleccionar opci√≥n
        function selectOptionCasoClinico(element, optionIndex) {
            console.log('üîç Funci√≥n selectOptionCasoClinico ejecutada');
            console.log('Elemento:', element);
            console.log('√çndice de opci√≥n:', optionIndex);
            console.log('quizAnswered:', quizAnswered);
            
            if (quizAnswered) {
                console.log('‚ùå Quiz ya respondido, no se puede seleccionar');
                return;
            }
            
            // Remover selecci√≥n anterior
            document.querySelectorAll('.quiz-option').forEach(opt => {
                opt.classList.remove('selected');
            });
            
            // Agregar selecci√≥n nueva
            element.classList.add('selected');
            console.log('‚úÖ Opci√≥n seleccionada:', element.textContent);
            
            // Habilitar bot√≥n de responder
            const checkBtn = document.getElementById('checkBtn');
            if (checkBtn) {
                checkBtn.disabled = false;
                console.log('‚úÖ Bot√≥n de responder habilitado');
            } else {
                console.log('‚ùå No se encontr√≥ el bot√≥n de responder');
            }
        }

        // Funci√≥n para verificar respuesta
        function checkAnswerCasoClinico() {
            if (quizAnswered) return;
            
            const selected = document.querySelector('.quiz-option.selected');
            if (!selected) return;
            
            const selectedIndex = Array.from(document.querySelectorAll('.quiz-option')).indexOf(selected);
            const caso = casosClinicos[casoActual];
            const pregunta = caso.preguntas[preguntaActual];
            
            quizAnswered = true;
            
            // Marcar opciones correctas e incorrectas
            document.querySelectorAll('.quiz-option').forEach((option, index) => {
                if (index === pregunta.respuesta_correcta) {
                    option.classList.add('correct');
                } else if (index === selectedIndex && index !== pregunta.respuesta_correcta) {
                    option.classList.add('incorrect');
                }
            });
            
            let result, resultClass;
            if (selectedIndex === pregunta.respuesta_correcta) {
                puntajeCasosClinicos++;
                result = '¬°Correcto! üéâ';
                resultClass = 'success';
            } else {
                result = `Incorrecto. La respuesta correcta es: ${pregunta.opciones[pregunta.respuesta_correcta]}`;
                resultClass = 'error';
            }
            
            const resultDiv = document.createElement('div');
            resultDiv.className = resultClass;
            resultDiv.innerHTML = `
                <div>${result}</div>
                <div style="margin-top: 0.5rem; font-size: 0.9rem; opacity: 0.9;">
                    <strong>Explicaci√≥n:</strong> ${pregunta.explicacion}
                </div>
            `;
            document.getElementById('quizContent').appendChild(resultDiv);
            document.getElementById('checkBtn').disabled = true;
            
            // Esperar 3 segundos antes de mostrar el bot√≥n de siguiente
            setTimeout(() => {
                const nextBtn = document.createElement('button');
                nextBtn.className = 'btn';
                nextBtn.style.marginLeft = '1rem';
                nextBtn.style.marginTop = '1rem';
                
                if (preguntaActual < caso.preguntas.length - 1) {
                    // Siguiente pregunta del mismo caso
                    nextBtn.textContent = 'Siguiente pregunta ‚û°Ô∏è';
                    nextBtn.onclick = () => {
                        preguntaActual++;
                        quizAnswered = false;
                        showCasoClinico();
                    };
                } else if (casoActual < casosClinicos.length - 1) {
                    // Siguiente caso
                    nextBtn.textContent = 'Siguiente caso ‚û°Ô∏è';
                    nextBtn.onclick = () => {
                        casoActual++;
                        preguntaActual = 0;
                        quizAnswered = false;
                        showCasoClinico();
                    };
                } else {
                    // Finalizar
                    nextBtn.textContent = 'Finalizar evaluaci√≥n üèÅ';
                    nextBtn.onclick = () => {
                        casoActual++;
                        showCasoClinico();
                    };
                }
                document.getElementById('quizContent').appendChild(nextBtn);
            }, 3000);
        }

        // Funci√≥n para resetear la secci√≥n
        function resetQuizSection() {
            // Ocultar quiz y mostrar contenido inicial
            document.getElementById('quizContent').style.display = 'none';
            document.querySelector('.assistant-intro').style.display = 'block';
            document.querySelector('.chat-interface').style.display = 'block';
            document.querySelector('.clinical-cases-section').style.display = 'block';
        }

            // Inicializaci√≥n al cargar la p√°gina
    window.onload = function() {
        alert('üöÄ VERSI√ìN ACTUALIZADA 15:30 - Si ves este mensaje, el LMS est√° cargando el archivo correcto');
        console.log('üöÄ LMS - P√°gina cargada correctamente - Versi√≥n actualizada 15:30');
        console.log('üîó API URL configurada:', 'https://asistente-auxiliar-farmacia.onrender.com');
        // La p√°gina ya est√° lista para usar
    };
    </script>
</body>
</html> 