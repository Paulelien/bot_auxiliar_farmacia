
<!DOCTYPE html>
<!-- Última actualización: 2024-12-19 17:15 - ESTILOS QUIZ CORREGIDOS - VISUALIZACIÓN DE SELECCIÓN -->
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>NEXO - Asistente Virtual de Farmacia</title>
    <style>
        :root {
            --color-primario: #4B2067;
            --color-secundario: #7C3FAF;
            --color-acento: #FF6B35;
            --color-texto: #2C3E50;
            --color-fondo: #F8F9FA;
            --color-rojo: #FF0000;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: #F8F9FA;
            min-height: 100vh;
            color: var(--color-texto);
            line-height: 1.6;
        }

        .container {
            max-width: 900px;
            margin: 0 auto;
            padding: 25px 15px;
        }

        /* Sección del Asistente Virtual */
        .assistant-intro {
            background: white;
            border-radius: 12px;
            padding: 2rem;
            margin-bottom: 2rem;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            border: 1px solid #E9ECEF;
        }

        .assistant-intro p {
            font-size: 1.1rem;
            color: var(--color-texto);
            text-align: center;
            margin-bottom: 0;
        }

        .warning-message {
            background: #FFF3CD;
            border: 1px solid #FFEAA7;
            border-radius: 8px;
            padding: 1rem;
            margin-bottom: 1rem;
            color: #856404;
            font-size: 0.95rem;
            line-height: 1.5;
        }

        .warning-message strong {
            color: #856404;
            font-weight: 600;
        }



        /* Chat Interface */
        .chat-interface {
            background: white;
            border-radius: 12px;
            padding: 2rem;
            margin-bottom: 2rem;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            border: 1px solid #E9ECEF;
        }

        .chat-window {
            background: #F8F9FA;
            border-radius: 12px;
            padding: 1.5rem;
            border: 1px solid #E9ECEF;
            min-height: 200px;
            margin-bottom: 1.5rem;
            position: relative;
            overflow-y: auto;
            max-height: 400px;
            -webkit-overflow-scrolling: touch;
        }

        .chat-message {
            display: flex;
            justify-content: flex-end;
            margin-bottom: 1rem;
        }

        /* Nota informativa */
        .info-note {
            background: var(--color-secundario);
            border: 1px solid var(--color-secundario);
            border-radius: 8px;
            padding: 0.75rem 1rem;
            margin-bottom: 1rem;
            color: white;
            font-size: 0.9rem;
            display: flex;
            align-items: center;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        .info-note i {
            font-size: 1.1rem;
        }

        /* Estilos base para chat-bubble */
        .chat-bubble {
            background: var(--color-secundario);
            color: white;
            padding: 1rem 1.5rem;
            border-radius: 20px;
            max-width: 70%;
            position: relative;
            margin-left: auto;
            word-wrap: break-word;
            overflow-wrap: break-word;
            line-height: 1.5;
            text-align: center;
            white-space: normal;
            overflow: visible;
        }

        .chat-bubble::before {
            content: '';
            position: absolute;
            right: -10px;
            top: 50%;
            transform: translateY(-50%);
            width: 0;
            height: 0;
            border-left: 10px solid var(--color-secundario);
            border-top: 8px solid transparent;
            border-bottom: 8px solid transparent;
        }

        .chat-bubble.user-bubble::before {
            right: auto;
            left: -10px;
            border-left: none;
            border-right: 10px solid #E8F5E8;
        }

        .chat-input-container {
            display: flex;
            gap: 1rem;
            align-items: center;
        }

        .chat-input-field {
            flex: 1;
            padding: 1rem 1.5rem;
            border: 1px solid #E9ECEF;
            border-radius: 25px;
            font-size: 16px;
            background: white;
        }

        .chat-input-field:focus {
            outline: none;
            border-color: var(--color-secundario);
        }

        .btn-send {
            background: var(--color-primario);
            color: white;
            border: none;
            border-radius: 25px;
            padding: 1rem 2rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .btn-send:hover {
            background: var(--color-secundario);
        }

        .chat-actions {
            display: flex;
            gap: 0.5rem;
        }

        .btn-action {
            background: none;
            border: none;
            padding: 0.5rem;
            cursor: pointer;
            border-radius: 50%;
            transition: background 0.3s ease;
        }

        .btn-action:hover {
            background: #E9ECEF;
        }

        .btn-action i {
            font-size: 1.2rem;
            color: #666;
        }

        /* Sección de Casos Clínicos */
        .clinical-cases-section {
            background: white;
            border-radius: 8px;
            padding: 3rem;
            margin-bottom: 2rem;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
            border: 1px solid #E9ECEF;
        }

        .case-header {
            display: flex;
            align-items: center;
            margin-bottom: 2rem;
        }

        .case-icon {
            background: var(--color-rojo);
            color: white;
            width: 40px;
            height: 40px;
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.5rem;
            font-weight: bold;
            margin-right: 1rem;
        }

        .case-title {
            font-size: 1.5rem;
            font-weight: 600;
            color: var(--color-texto);
        }

        .case-description {
            color: var(--color-texto);
            margin-bottom: 2.5rem;
            line-height: 1.8;
            font-size: 1.05rem;
        }

        .btn-start-practice {
            background: var(--color-primario);
            color: white;
            border: none;
            border-radius: 8px;
            padding: 1rem 2rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            margin-right: 1rem;
        }

        .btn-start-practice:hover {
            background: var(--color-secundario);
        }

        .case-actions {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .case-controls {
            display: flex;
            gap: 0.5rem;
        }

        .btn-control {
            background: none;
            border: none;
            padding: 0.5rem;
            cursor: pointer;
            border-radius: 50%;
            transition: background 0.3s ease;
        }

        .btn-control:hover {
            background: #E9ECEF;
        }

        .btn-control i {
            font-size: 1.2rem;
            color: #666;
        }

        /* Contenedor del Quiz */
        #quizContent {
            background: white;
            border-radius: 8px;
            padding: 3.5rem;
            margin-bottom: 2rem;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
            border: 1px solid #E9ECEF;
            position: relative;
        }

        #quizContent::before {
            content: '';
            position: absolute;
            left: 0;
            top: 0;
            bottom: 0;
            width: 4px;
            background: #E9ECEF;
            border-radius: 8px 0 0 8px;
        }

        /* Responsive */
        @media (max-width: 768px) {
            .container {
                padding: 10px;
                max-width: 100%;
            }
            
            .chat-interface {
                padding: 1rem;
                margin-bottom: 1rem;
            }
            
            .chat-window {
                padding: 1rem;
                min-height: 150px;
                max-height: 300px;
                overflow-y: auto;
                -webkit-overflow-scrolling: touch;
            }
            
            .chat-bubble {
                max-width: 100%;
                padding: 1rem 1.2rem;
                font-size: 0.9rem;
                line-height: 1.5;
                word-wrap: break-word;
                overflow-wrap: break-word;
                text-align: center;
                margin: 0 auto 0 auto;
                white-space: normal;
                overflow: visible;
                width: auto;
            }
            
            .chat-bubble:not(.user-bubble) {
                max-width: 100%;
                white-space: normal;
                word-break: normal;
                text-align: center;
                overflow: visible;
                width: auto;
            }
            
            .chat-input-container {
                flex-direction: column;
                gap: 0.8rem;
                width: 100%;
                padding: 0 0.5rem;
            }
            
            .chat-input-field {
                padding: 0.8rem 1rem;
                font-size: 16px;
                width: 100%;
                min-width: 100%;
            }
            
            .btn-send {
                padding: 0.8rem 1.5rem;
                font-size: 0.9rem;
                width: 100%;
            }
            
            .chat-actions {
                justify-content: center;
            }
            
            .case-actions {
                flex-direction: column;
                gap: 1rem;
                align-items: stretch;
            }
            
            .clinical-cases-section {
                padding: 1.5rem;
                margin-bottom: 1rem;
            }
            
            #quizContent {
                padding: 1.5rem;
                margin-bottom: 1rem;
            }
            
            .assistant-intro {
                padding: 1.5rem;
                margin-bottom: 1rem;
            }
            
            .warning-message {
                padding: 0.8rem;
                font-size: 0.85rem;
                line-height: 1.4;
            }
            
            /* Mejoras específicas para respuestas largas del bot */
            .chat-message .chat-bubble {
                max-height: none;
                overflow-y: visible;
                -webkit-overflow-scrolling: auto;
                scrollbar-width: none;
                scrollbar-color: transparent transparent;
            }
            
            .chat-message .chat-bubble::-webkit-scrollbar {
                width: 4px;
            }
            
            .chat-message .chat-bubble::-webkit-scrollbar-track {
                background: transparent;
            }
            
            .chat-message .chat-bubble::-webkit-scrollbar-thumb {
                background: rgba(255,255,255,0.3);
                border-radius: 2px;
            }
            
            .chat-message .chat-bubble::-webkit-scrollbar-thumb:hover {
                background: rgba(255,255,255,0.5);
            }
            
            /* Ajustes para texto largo */
            .chat-bubble p {
                margin-bottom: 0.5rem;
            }
            
            .chat-bubble p:last-child {
                margin-bottom: 0;
            }
            
            /* Mejor espaciado para listas */
            .chat-bubble ul, .chat-bubble ol {
                padding-left: 1rem;
                margin: 0.5rem 0;
            }
            
            .chat-bubble li {
                margin-bottom: 0.3rem;
            }
        }
        
        /* Estilos específicos para pantallas muy pequeñas */
        @media (max-width: 480px) {
            .container {
                padding: 5px;
            }
            
            .chat-bubble {
                max-width: 100%;
                padding: 1rem 0.8rem;
                font-size: 0.9rem;
                text-align: center;
                margin: 0 auto 0 auto;
                white-space: normal;
                overflow: visible;
                line-height: 1.5;
                width: auto;
            }
            
            .chat-window {
                max-height: 250px;
            }
            
            .chat-message .chat-bubble {
                max-height: none;
            }
            
            .assistant-intro,
            .chat-interface,
            .clinical-cases-section {
                padding: 1rem;
            }
            
            #quizContent {
                padding: 1rem;
            }

            .chat-input-field {
                padding: 1rem 1.2rem;
                font-size: 16px;
                width: 100%;
                min-width: 100%;
                border-radius: 20px;
            }
            
            .btn-send {
                padding: 1rem 2rem;
                font-size: 1rem;
                width: 100%;
                border-radius: 20px;
            }
        }

        /* Estilos para el Quiz de Casos Clínicos */
        .quiz-question {
            font-size: 1.3rem;
            font-weight: 700;
            color: #000;
            margin-bottom: 2rem;
            line-height: 1.4;
        }

        .quiz-description {
            font-size: 1.05rem;
            color: #333;
            margin-bottom: 2.5rem;
            line-height: 1.7;
        }

        /* Estilos para la estructura del caso clínico */
        .caso-clinico {
            margin-bottom: 2.5rem;
        }

        .caso-titulo {
            font-size: 1.4rem;
            font-weight: 700;
            color: #000;
            margin-bottom: 1.5rem;
            line-height: 1.3;
        }

        .caso-descripcion {
            font-size: 1.05rem;
            color: #333;
            line-height: 1.7;
            margin-bottom: 2rem;
        }

        .caso-info {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 2.5rem;
            padding: 1rem 0;
        }

        .caso-numeros {
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
        }

        .caso-numero {
            font-weight: 600;
            color: #000;
            font-size: 1rem;
        }

        .pregunta-numero {
            font-weight: 500;
            color: #333;
            font-size: 0.95rem;
        }

        .puntaje-actual {
            font-weight: 600;
            color: #000;
            font-size: 1rem;
        }

        .quiz-options {
            display: flex;
            flex-direction: column;
            gap: 1.2rem;
            margin-bottom: 2.5rem;
        }

        .quiz-option {
            background: white;
            border: 1px solid #E9ECEF;
            border-radius: 6px;
            padding: 1.5rem 2rem;
            cursor: pointer;
            transition: all 0.3s ease;
            font-size: 1rem;
            color: var(--color-texto);
            margin: 0;
        }

        .quiz-option:hover {
            border-color: var(--color-secundario);
            background: #F8F9FA;
        }

        .quiz-option.selected {
            background: white;
            color: #333;
            border: 2px solid var(--color-secundario);
            position: relative;
        }

        .quiz-option.selected::before {
            display: none;
        }

        .quiz-option.correct {
            background: white;
            color: #333;
            border: 2px solid #028100;
        }

        .quiz-option.incorrect {
            background: white;
            color: #333;
            border: 2px solid #B20710;
        }

        .quiz-progress {
            background: #F8F9FA;
            border-radius: 8px;
            padding: 1rem;
            margin-bottom: 1.5rem;
            text-align: center;
            font-weight: 600;
            color: var(--color-texto);
        }

        .btn {
            background: var(--color-primario);
            color: white;
            border: none;
            border-radius: 8px;
            padding: 0.8rem 1.5rem;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
        }



        .btn:hover {
            background: var(--color-secundario);
        }

        .btn:disabled {
            background: #6C757D;
            cursor: not-allowed;
        }

        .success {
            background: #D4EDDA;
            color: #155724;
            border: 1px solid #C3E6CB;
            border-radius: 8px;
            padding: 1rem;
            margin-top: 1rem;
        }

        .error {
            background: #F8D7DA;
            color: #721C24;
            border: 1px solid #F5C6CB;
            border-radius: 8px;
            padding: 1rem;
            margin-top: 1rem;
        }

        /* Botón para volver al chat */
        .btn-back-to-chat {
            background: transparent;
            color: #8B5A8B;
            border: 1px solid #8B5A8B;
            border-radius: 8px;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            font-size: 1rem;
            font-weight: 600;
            padding: 0.8rem 1.5rem;
            text-align: center;
            margin-left: auto;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .btn-back-to-chat:hover {
            background: #8B5A8B;
            color: white;
            transform: translateY(-1px);
        }

        .case-header {
            display: flex;
            align-items: center;
            gap: 1rem;
        }

        /* Estilo específico para el botón siguiente pregunta */
        .btn-siguiente-pregunta {
            background: #7c3faf;
            color: white;
            border: none;
            border-radius: 8px;
            padding: 0.8rem 1.5rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .btn-siguiente-pregunta:hover {
            background: #6a2f9f;
            transform: translateY(-1px);
        }
        .chat-bubble p {
            margin-bottom: 0.8rem;
            line-height: 1.6;
        }

        .chat-bubble p:last-child {
            margin-bottom: 0;
        }

        .chat-bubble ul, .chat-bubble ol {
            padding-left: 1.2rem;
            margin: 0.8rem 0;
            line-height: 1.6;
        }

        .chat-bubble li {
            margin-bottom: 0.5rem;
            line-height: 1.5;
        }

        .chat-bubble strong, .chat-bubble b {
            font-weight: 600;
        }

        .chat-bubble em {
            font-style: italic;
        }
        
        .chat-bubble i:not(.fas):not(.far):not(.fab):not(.fa) {
            font-style: italic;
        }
        
        /* Asegurar que todos los iconos de Font Awesome NO estén en itálica */
        i.fas, i.far, i.fab, i.fa {
            font-style: normal !important;
        }

        /* Mejoras específicas para mensajes de carga */
        .chat-bubble.loading-message {
            text-align: center;
            padding: 1.2rem 1.5rem;
            white-space: normal;
            overflow: visible;
            word-wrap: normal;
            word-break: normal;
        }

        .chat-bubble.loading-message p {
            margin: 0;
            text-align: center;
            white-space: normal;
            overflow: visible;
        }

        /* Estilos específicos para móviles - mensajes de carga */
        @media (max-width: 768px) {
            .chat-bubble.loading-message {
                max-width: 100%;
                padding: 1rem 1rem;
                font-size: 0.9rem;
                line-height: 1.5;
                white-space: normal;
                overflow: visible;
                width: auto;
            }
        }

        @media (max-width: 480px) {
            .chat-bubble.loading-message {
                max-width: 100%;
                padding: 1rem 0.8rem;
                font-size: 0.9rem;
                line-height: 1.5;
                white-space: normal;
                overflow: visible;
                width: auto;
            }
        }

        /* Eliminar sangrías y problemas de texto cortado */
        .chat-bubble {
            text-indent: 0;
            padding-left: 1.5rem;
            padding-right: 1.5rem;
        }

        @media (max-width: 768px) {
            .chat-bubble {
                text-indent: 0;
                padding-left: 1rem;
                padding-right: 1rem;
                margin-left: 0;
                margin-right: 0;
            }
        }

        @media (max-width: 480px) {
            .chat-bubble {
                text-indent: 0;
                padding-left: 0.8rem;
                padding-right: 0.8rem;
                margin-left: 0;
                margin-right: 0;
            }
        }
    </style>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
</head>
<body>
    <div class="container">
        <!-- Sección del Asistente Virtual -->
        <div class="assistant-intro">
            <div class="warning-message">
                <strong>⚠️ Importante:</strong> Este chatbot está en periodo de prueba. Su contenido se basa en los manuales del curso y puede presentar inconsistencias. Si detectas errores o tienes dudas, contacta al tutor en la pestaña «Consultas académicas».
            </div>

            <p>¡Hola! Soy NEXO tu asistente virtual. Estoy aquí para ayudarte con tus dudas 
                sobre el curso de Auxiliar de Farmacia. </p>

        </div>

        <!-- Interfaz de Chat -->
        <div class="chat-interface">
            <!-- Nota informativa sobre tiempo de respuesta -->
            <div class="info-note">
                <i class="fas fa-info-circle" style="color: #007bff; margin-right: 0.5rem;"></i>
                <strong>Nota:</strong> La primera pregunta puede demorar más tiempo en ser respondida mientras el sistema se inicializa.
            </div>
            
            <!-- Indicador de sesión activa (oculto) -->
            <div id="sessionIndicator" style="display: none;">
                <i class="fas fa-circle" style="color: #28a745; margin-right: 0.5rem;"></i>
                Sesión activa - Tiempo restante: <span id="sessionTimer">01:00</span>
            </div>
            
            <div class="chat-window" id="chatWindow">
                <div class="chat-message">
                    <div class="chat-bubble">
                        <strong>NEXO:</strong> ¡Hola! Soy NEXO tu asistente virtual. ¿En qué puedo ayudarte hoy con respecto al curso de Auxiliar de Farmacia y sus manuales?
                    </div>
                </div>
            </div>
            
            <div class="chat-input-container">
                <button class="btn-send" onclick="sendQuestion()" id="sendBtn">Enviar</button>
                <input type="text" id="questionInput" class="chat-input-field" placeholder="Escribe tu pregunta aquí" onkeypress="handleKeyPress(event)">
                            <div class="chat-actions">
                <button class="btn-action" onclick="clearChat()" title="Limpiar chat">
                    <i class="fas fa-trash"></i>
                </button>
                <button class="btn-action" onclick="exportChat()" title="Exportar chat">
                    <i class="fas fa-file-export"></i>
                </button>

            </div>
            </div>
        </div>

        <!-- Sección de Casos Clínicos -->
        <div class="clinical-cases-section">
            <div class="case-header">
                <div class="case-icon">+</div>
                <div class="case-title">Práctica con casos clínicos</div>
            </div>
            
            <div class="case-description">
                ¡Prepárate para tu examen con casos clínicos reales! Practica en un entorno seguro y sin repercusiones negativas, diseñado para ayudarte a ensayar y reforzar tus conocimientos. Esta herramienta te permitirá familiarizarte con el tipo de preguntas que podrías enfrentar en el examen de competencia ante la SEREMI de Salud. La práctica tiene una duración aproximada de 15 minutos. ¡Aumenta tu confianza y asegura tu éxito!
            </div>
            
            <div class="case-actions">
                <button class="btn-start-practice" onclick="startCasosClinicos()">Iniciar Práctica</button>
                <div class="case-controls">
                    <button class="btn-control" onclick="refreshCases()" title="Recargar">
                        <i class="fas fa-redo"></i>
                    </button>
                    <button class="btn-control" onclick="shuffleCases()" title="Mezclar">
                        <i class="fas fa-random"></i>
                    </button>
                </div>
            </div>
        </div>

        <!-- Contenido de Casos Clínicos (oculto inicialmente) -->
        <div id="quizContent" style="display: none;"></div>
    </div>

    <script>
        // CASOS CLÍNICOS INTEGRADOS DIRECTAMENTE - TODOS LOS CASOS
        const CASOS_CLINICOS = {
            "casos_clinicos": [
                {
                    "id": 1,
                    "titulo": "Caso Clínico: Paciente con Hipertensión",
                    "descripcion": "María, 65 años, acude a la farmacia con una receta médica para tratar su hipertensión arterial. Presenta presión arterial de 160/95 mmHg y tiene antecedentes de diabetes tipo 2.",
                    "preguntas": [
                        {
                            "id": 1,
                            "pregunta": "¿Cuál de los siguientes medicamentos NO es un antihipertensivo?",
                            "opciones": [
                                "A) Losartán",
                                "B) Amlodipino", 
                                "C) Paracetamol",
                                "D) Enalapril"
                            ],
                            "respuesta_correcta": 2,
                            "explicacion": "El paracetamol es un analgésico y antipirético, no un antihipertensivo. Losartán, Amlodipino y Enalapril son medicamentos antihipertensivos."
                        },
                        {
                            "id": 2,
                            "pregunta": "¿Qué precaución especial debe tener María al tomar antihipertensivos?",
                            "opciones": [
                                "A) Tomar con el estómago lleno",
                                "B) Evitar cambios bruscos de posición",
                                "C) Exponerse al sol sin protección",
                                "D) Hacer ejercicio intenso inmediatamente"
                            ],
                            "respuesta_correcta": 1,
                            "explicacion": "Los antihipertensivos pueden causar hipotensión ortostática, por lo que se debe evitar levantarse bruscamente."
                        },
                        {
                            "id": 3,
                            "pregunta": "¿Cuál es el valor normal de presión arterial para adultos?",
                            "opciones": [
                                "A) 140/90 mmHg",
                                "B) 120/80 mmHg",
                                "C) 160/100 mmHg", 
                                "D) 180/110 mmHg"
                            ],
                            "respuesta_correcta": 1,
                            "explicacion": "El valor normal de presión arterial es menor a 120/80 mmHg."
                        },
                        {
                            "id": 4,
                            "pregunta": "¿Qué efecto secundario es común en los inhibidores de la ECA?",
                            "opciones": [
                                "A) Tos seca",
                                "B) Diarrea",
                                "C) Insomnio",
                                "D) Pérdida de apetito"
                            ],
                            "respuesta_correcta": 0,
                            "explicacion": "La tos seca es un efecto secundario frecuente de los inhibidores de la ECA como el enalapril."
                        },
                        {
                            "id": 5,
                            "pregunta": "¿Qué recomendación dietética es importante para María?",
                            "opciones": [
                                "A) Aumentar el consumo de sal",
                                "B) Reducir el consumo de sodio",
                                "C) Consumir más grasas saturadas",
                                "D) Evitar las verduras"
                            ],
                            "respuesta_correcta": 1,
                            "explicacion": "La reducción del consumo de sodio es fundamental en el tratamiento de la hipertensión arterial."
                        }
                    ]
                },
                {
                    "id": 2,
                    "titulo": "Caso Clínico: Paciente con Diabetes",
                    "descripcion": "Carlos, 45 años, diagnosticado recientemente con diabetes tipo 2. Acude a la farmacia para recibir orientación sobre su medicación y cuidados generales.",
                    "preguntas": [
                        {
                            "id": 1,
                            "pregunta": "¿Cuál es el objetivo principal del tratamiento de la diabetes tipo 2?",
                            "opciones": [
                                "A) Curar la enfermedad",
                                "B) Mantener niveles normales de glucosa",
                                "C) Eliminar la insulina del cuerpo",
                                "D) Reducir el peso corporal únicamente"
                            ],
                            "respuesta_correcta": 1,
                            "explicacion": "El objetivo principal es mantener niveles normales de glucosa en sangre para prevenir complicaciones."
                        },
                        {
                            "id": 2,
                            "pregunta": "¿Qué medicamento oral es de primera línea para la diabetes tipo 2?",
                            "opciones": [
                                "A) Insulina",
                                "B) Metformina",
                                "C) Glibenclamida",
                                "D) Pioglitazona"
                            ],
                            "respuesta_correcta": 1,
                            "explicacion": "La metformina es el medicamento de primera línea para el tratamiento de la diabetes tipo 2."
                        },
                        {
                            "id": 3,
                            "pregunta": "¿Cuál es el valor normal de glucosa en ayunas?",
                            "opciones": [
                                "A) 70-100 mg/dL",
                                "B) 100-126 mg/dL",
                                "C) 126-200 mg/dL",
                                "D) Más de 200 mg/dL"
                            ],
                            "respuesta_correcta": 0,
                            "explicacion": "Los valores normales de glucosa en ayunas son entre 70-100 mg/dL."
                        },
                        {
                            "id": 4,
                            "pregunta": "¿Qué complicación es más frecuente en pacientes diabéticos?",
                            "opciones": [
                                "A) Problemas cardíacos",
                                "B) Problemas renales",
                                "C) Problemas oculares",
                                "D) Todas las anteriores"
                            ],
                            "respuesta_correcta": 3,
                            "explicacion": "La diabetes puede afectar múltiples órganos, siendo frecuentes las complicaciones cardíacas, renales y oculares."
                        },
                        {
                            "id": 5,
                            "pregunta": "¿Qué recomendación es importante para el autocontrol de la diabetes?",
                            "opciones": [
                                "A) Medir glucosa solo cuando se sienta mal",
                                "B) Realizar controles regulares de glucosa",
                                "C) No medir nunca la glucosa",
                                "D) Medir solo una vez al mes"
                            ],
                            "respuesta_correcta": 1,
                            "explicacion": "El autocontrol regular de la glucosa es fundamental para el manejo adecuado de la diabetes."
                        }
                    ]
                },
                {
                    "id": 3,
                    "titulo": "Caso Clínico: Paciente con Dolor Crónico",
                    "descripcion": "Ana, 58 años, padece artritis reumatoide y acude a la farmacia con dolor crónico en las articulaciones. Toma medicamentos antiinflamatorios regularmente.",
                    "preguntas": [
                        {
                            "id": 1,
                            "pregunta": "¿Qué tipo de medicamento es más apropiado para el dolor crónico de Ana?",
                            "opciones": [
                                "A) Paracetamol",
                                "B) Ibuprofeno",
                                "C) Morfina",
                                "D) Aspirina"
                            ],
                            "respuesta_correcta": 1,
                            "explicacion": "Los antiinflamatorios no esteroideos como el ibuprofeno son apropiados para el dolor inflamatorio crónico."
                        },
                        {
                            "id": 2,
                            "pregunta": "¿Qué efecto secundario es común en los AINEs?",
                            "opciones": [
                                "A) Problemas gastrointestinales",
                                "B) Somnolencia",
                                "C) Pérdida de memoria",
                                "D) Visión borrosa"
                            ],
                            "respuesta_correcta": 0,
                            "explicacion": "Los AINEs pueden causar irritación gástrica y úlceras, por lo que deben tomarse con alimentos."
                        },

                        {
                            "id": 3,
                            "pregunta": "¿Qué recomendación es importante para Ana?",
                            "opciones": [
                                "A) Tomar medicamentos con el estómago vacío",
                                "B) Tomar medicamentos con alimentos",
                                "C) No hacer ejercicio",
                                "D) Evitar el reposo"
                            ],
                            "respuesta_correcta": 1,
                            "explicacion": "Los AINEs deben tomarse con alimentos para reducir la irritación gástrica."
                        },
                        {
                            "id": 4,
                            "pregunta": "¿Qué terapia complementaria puede ayudar a Ana?",
                            "opciones": [
                                "A) Fisioterapia",
                                "B) Acupuntura",
                                "C) Ejercicio moderado",
                                "D) Todas las anteriores"
                            ],
                            "respuesta_correcta": 3,
                            "explicacion": "Todas estas terapias complementarias pueden ayudar en el manejo del dolor crónico."
                        }
                    ]
                },
                {
                    "id": 4,
                    "titulo": "Caso Clínico: Paciente Pediátrico",
                    "descripcion": "Lucas, 8 años, presenta fiebre de 38.5°C y dolor de garganta. Su madre acude a la farmacia buscando orientación sobre el tratamiento adecuado.",
                    "preguntas": [
                        {
                            "id": 1,
                            "pregunta": "¿Qué medicamento es seguro para la fiebre en niños?",
                            "opciones": [
                                "A) Aspirina",
                                "B) Paracetamol",
                                "C) Ibuprofeno",
                                "D) B y C son correctas"
                            ],
                            "respuesta_correcta": 3,
                            "explicacion": "Tanto el paracetamol como el ibuprofeno son seguros para niños, pero nunca aspirina por riesgo de síndrome de Reye."
                        },

                        {
                            "id": 2,
                            "pregunta": "¿Cuándo se debe derivar al médico un niño con fiebre?",
                            "opciones": [
                                "A) Siempre que tenga fiebre",
                                "B) Si la fiebre persiste más de 3 días",
                                "C) Solo si la fiebre es muy alta",
                                "D) Nunca es necesario"
                            ],
                            "respuesta_correcta": 1,
                            "explicacion": "Se debe derivar al médico si la fiebre persiste más de 3 días o si hay otros síntomas preocupantes."
                        },
                        {
                            "id": 3,
                            "pregunta": "¿Qué medida no farmacológica es útil para la fiebre?",
                            "opciones": [
                                "A) Baños con agua fría",
                                "B) Baños con agua tibia",
                                "C) Abrigar mucho al niño",
                                "D) No dar líquidos"
                            ],
                            "respuesta_correcta": 1,
                            "explicacion": "Los baños con agua tibia ayudan a bajar la fiebre de forma segura."
                        },
                        {
                            "id": 4,
                            "pregunta": "¿Qué es importante verificar antes de administrar medicamentos a niños?",
                            "opciones": [
                                "A) Solo el peso",
                                "B) Solo la edad",
                                "C) Peso, edad y antecedentes alérgicos",
                                "D) Solo si tiene hambre"
                            ],
                            "respuesta_correcta": 2,
                            "explicacion": "Es fundamental verificar peso, edad y antecedentes alérgicos antes de administrar medicamentos a niños."
                        }
                    ]
                },
                {
                    "id": 5,
                    "titulo": "Caso Clínico: Gestión de Almacenamiento de Vacunas e Insulina",
                    "descripcion": "Un auxiliar de farmacia recibe un nuevo lote de vacunas y jeringas precargadas de insulina. Estos productos requieren condiciones especiales de almacenamiento para mantener su calidad y eficacia.",
                    "preguntas": [
                        {
                            "id": 1,
                            "pregunta": "Considerando el vencimiento y la necesidad de cadena de frío, ¿cuál de las siguientes combinaciones de principio de gestión de existencias y rango de temperatura es la más adecuada para estos productos?",
                            "opciones": [
                                "A) FIFO (First In, First Out) a 15-25°C",
                                "B) LIFO (Last In, First Out) a 8-15°C", 
                                "C) FEFO (First Expired, First Out) a 2-8°C",
                                "D) FSN (Fast, Slow, Non-moving) a menos de 0°C"
                            ],
                            "respuesta_correcta": 2,
                            "explicacion": "La alternativa correcta es c) FEFO (First Expired, First Out) a 2-8°C. El principio FEFO, acrónimo en inglés de \"First Expired, First Out\", es fundamental para el auxiliar de farmacia y rige la norma 147. Este principio prioriza la salida de los productos cuya fecha de caducidad está más próxima, independientemente del lote, lo cual ayuda a prevenir pérdidas por vencimiento. Tanto las vacunas como las insulinas son productos que requieren mantener una cadena de frío estricta, lo que significa que deben conservarse a una temperatura entre 2 y 8°C. Es importante recordar que la insulina NUNCA debe ser congelada."
                        }
                    ]
                },
                {
                    "id": 6,
                    "titulo": "Caso Clínico: Cálculo Posológico - Ácido Valproico Gotas",
                    "descripcion": "Un paciente acude a la farmacia con una receta para Ácido Valproico Gotas. La indicación médica es \"administrar 23 gotas cada 12 horas por 3 meses\". La farmacia solo dispone de Ácido Valproico en una presentación de frascos de 25 mL, y se sabe que 20 gotas equivalen a 1 mL.",
                    "preguntas": [
                        {
                            "id": 1,
                            "pregunta": "¿Cuántos frascos de 25 mL de Ácido Valproico Gotas debería dispensar el auxiliar de farmacia para cubrir el tratamiento completo de este paciente?",
                            "opciones": [
                                "A) 8 frascos",
                                "B) 9 frascos",
                                "C) 10 frascos", 
                                "D) 4 frascos"
                            ],
                            "respuesta_correcta": 1,
                            "explicacion": "La alternativa correcta es b) 9 frascos. Para determinar la cantidad de frascos a dispensar, se realizan los siguientes cálculos posológicos: 1. Calcular la dosis diaria en gotas: La indicación \"cada 12 horas\" implica 2 administraciones al día (24 horas / 12 horas = 2). Por lo tanto, 23 gotas * 2 veces al día = 46 gotas diarias. 2. Calcular el total de gotas para el tratamiento: El tratamiento es por 3 meses, lo que se considera como 90 días. Entonces, 46 gotas/día * 90 días = 4.140 gotas necesarias para el tratamiento. 3. Determinar cuántas gotas contiene un frasco de 25 mL: Sabiendo que 20 gotas equivalen a 1 mL, un frasco de 25 mL contiene 25 mL * 20 gotas/mL = 500 gotas por frasco. 4. Calcular el número de frascos necesarios: Se divide el total de gotas requeridas por el número de gotas por frasco: 4.140 gotas / 500 gotas/frasco = 8,28 frascos. 5. Dado que no es posible dispensar frascos fraccionados y se debe asegurar la indemnidad del producto terminado y el cumplimiento completo del tratamiento, se debe redondear al entero superior. Por lo tanto, el auxiliar deberá dispensar 9 frascos al paciente."
                        }
                    ]
                },
                {
                    "id": 7,
                    "titulo": "Caso Clínico: Despacho de Medicamentos Estupefacientes",
                    "descripcion": "Un paciente presenta una receta para un medicamento clasificado como estupefaciente. En ese momento, el Químico Farmacéutico (Director Técnico) no se encuentra en el establecimiento, y el Auxiliar de Farmacia es el único personal presente con autorización para despachar otros tipos de recetas y manejar el abastecimiento.",
                    "preguntas": [
                        {
                            "id": 1,
                            "pregunta": "Según el Reglamento 466, ¿cuál es la acción correcta que debe tomar el Auxiliar de Farmacia en esta situación?",
                            "opciones": [
                                "A) Despachar la receta, haciendo constar su nombre y firma, ya que tiene autorización sanitaria para el despacho de productos farmacéuticos en general.",
                                "B) Negarse a despachar la receta y pedir al paciente que espere al Químico Farmacéutico, ya que el despacho de este tipo de medicamentos es una responsabilidad exclusiva de este último.",
                                "C) Informar al paciente que la farmacia no comercializa este tipo de medicamentos controlados.",
                                "D) Despachar la receta si cuenta con una autorización escrita del Químico Farmacéutico para acceder al área de control de stock."
                            ],
                            "respuesta_correcta": 1,
                            "explicacion": "La alternativa correcta es b) Negarse a despachar la receta y pedir al paciente que espere al Químico Farmacéutico, ya que el despacho de este tipo de medicamentos es una responsabilidad exclusiva de este último. El Reglamento 466 establece claramente que es responsabilidad del Químico Farmacéutico (Director Técnico) despachar personalmente las recetas de productos farmacéuticos sometidos a controles legales especiales, como estupefacientes y psicotrópicos, dejando constancia de su nombre y firma. Aunque el auxiliar de farmacia tiene responsabilidades en el despacho y manejo de productos farmacéuticos bajo la supervisión del director técnico, la función específica de despacho personal de sustancias controladas es atribuida al Químico Farmacéutico. El acceso al área de control de stock de estos productos está restringido al director técnico o personal autorizado por escrito por él, pero esto no delega la obligación de \"despacho personal\" del Químico Farmacéutico."
                        }
                    ]
                },
                {
                    "id": 8,
                    "titulo": "Caso Clínico: Validez de Recetas Magistrales",
                    "descripcion": "Un paciente acude a una farmacia que cuenta con recetario magistral, presentando una receta para una fórmula magistral (una crema tópica personalizada) que fue extendida por su médico hace 40 días. El auxiliar de farmacia debe verificar la validez de la receta antes de procesarla para su elaboración.",
                    "preguntas": [
                        {
                            "id": 1,
                            "pregunta": "¿Cuál es el estado de la receta magistral presentada por el paciente, según la normativa vigente?",
                            "opciones": [
                                "A) Es válida, ya que las recetas magistrales, al ser personalizadas, no tienen un plazo de caducidad estricto.",
                                "B) Es válida, siempre y cuando el médico revalide la fecha en la farmacia mediante un nuevo documento o firma.",
                                "C) No es válida, pues ha excedido el plazo legal de 30 días corridos desde su extensión.",
                                "D) Es válida si el auxiliar de farmacia, tras evaluar al paciente, considera que el tratamiento sigue siendo pertinente."
                            ],
                            "respuesta_correcta": 2,
                            "explicacion": "La alternativa correcta es c) No es válida, pues ha excedido el plazo legal de 30 días corridos desde su extensión. Los documentos indican que \"El plazo durante el cual una receta es válida para ser presentada a su elaboración en recetario es de 30 días corridos contados desde la fecha de su extensión\". Una vez superado este plazo, la receta pierde su validez para ser elaborada en el recetario, independientemente de la necesidad clínica o la valoración del auxiliar."
                        }
                    ]
                },
                {
                    "id": 9,
                    "titulo": "Caso Clínico: Almacenamiento de Medicamentos Fotosensibles",
                    "descripcion": "El auxiliar de farmacia Pablo está realizando una revisión de las condiciones de almacenamiento en la sala de ventas. Observa que varios envases de medicamentos fotosensibles (que deben protegerse de la luz) están ubicados cerca de un ventanal donde reciben luz solar directa durante varias horas al día. Adicionalmente, Pablo nota que los termómetros de máxima y mínima no se han registrado por escrito en los últimos cinco días en las distintas áreas de almacenamiento.",
                    "preguntas": [
                        {
                            "id": 1,
                            "pregunta": "¿Cuál de los siguientes factores de almacenamiento representa un riesgo inmediato para la calidad de los medicamentos fotosensibles observados y qué acción se requiere con respecto a la temperatura?",
                            "opciones": [
                                "A) La humedad, ya que promueve el crecimiento de bacterias y hongos en el producto.",
                                "B) La temperatura, aunque los medicamentos fotosensibles no se ven directamente afectados por ella.",
                                "C) La luz, que puede degradar los medicamentos, y el registro constante (al menos dos veces al día) y por escrito de la temperatura es obligatorio en todas las áreas de almacenamiento.",
                                "D) La falta de segregación física de los productos, que puede llevar a contaminación cruzada."
                            ],
                            "respuesta_correcta": 2,
                            "explicacion": "La alternativa correcta es c) La luz, que puede degradar los medicamentos, y el registro constante (al menos dos veces al día) y por escrito de la temperatura es obligatorio en todas las áreas de almacenamiento."
                        }
                    ]
                }
            ]
        };

        // Variables globales para el chat
        let chatHistory = [];
        let isFirstQuestion = true; // Variable para controlar si es la primera pregunta
        
        // Variables para tracking de sesión
        let sessionStartTime = Date.now();
        let lastActivityTime = Date.now();
        let sessionTimeout = 6 * 60 * 1000; // 6 minutos de inactividad
        let sessionTimer = null;
        let isSessionActive = true;

        // Variables globales para casos clínicos
        let casosClinicos = [];
        let casoActual = 0;
        let preguntaActual = 0;
        let puntajeCasosClinicos = 0;
        let totalPreguntasCasosClinicos = 0;
        let quizAnswered = false;

        // Función para manejar tecla Enter
        function handleKeyPress(event) {
            if (event.key === 'Enter') {
                sendQuestion();
            }
        }

        // Función para actualizar actividad del usuario (solo al hacer preguntas)
        function updateUserActivity() {
            lastActivityTime = Date.now();
            if (sessionTimer) {
                clearTimeout(sessionTimer);
            }
            sessionTimer = setTimeout(checkSessionTimeout, sessionTimeout);
            
            console.log('💬 Pregunta enviada - Timer reseteado a 6 minutos');
        }

        // Función para actualizar timer visual de sesión
        function updateSessionTimer() {
            const timerElement = document.getElementById('sessionTimer');
            if (!timerElement) return;
            
            const timeRemaining = Math.max(0, Math.ceil((sessionTimeout - (Date.now() - lastActivityTime)) / 1000 / 60));
            const minutes = Math.floor(timeRemaining / 60);
            const seconds = timeRemaining % 60;
            
            timerElement.textContent = `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
            
            // Cambiar color según tiempo restante
            const indicator = document.getElementById('sessionIndicator');
            if (timeRemaining <= 5) {
                indicator.style.background = '#FFF3CD';
                indicator.style.color = '#856404';
                indicator.querySelector('i').style.color = '#FFC107';
            } else if (timeRemaining <= 15) {
                indicator.style.background = '#F8D7DA';
                indicator.style.color = '#721C24';
                indicator.querySelector('i').style.color = '#DC3545';
            } else {
                indicator.style.background = '#E8F5E8';
                indicator.style.color = '#155724';
                indicator.querySelector('i').style.color = '#28A745';
            }
        }

        // Función para verificar timeout de sesión
        function checkSessionTimeout() {
            const currentTime = Date.now();
            const timeSinceLastActivity = currentTime - lastActivityTime;
            
            console.log('⏰ Verificando timeout - Tiempo transcurrido:', Math.round(timeSinceLastActivity / 1000), 'segundos');
            console.log('⏰ Timeout configurado:', Math.round(sessionTimeout / 1000), 'segundos');
            console.log('⏰ Sesión activa:', isSessionActive);
            
            if (timeSinceLastActivity >= sessionTimeout && isSessionActive) {
                console.log('🔚 TIMEOUT ACTIVADO - Cerrando sesión');
                endSession();
            }
        }

        // Función para finalizar sesión
        function endSession() {
            if (!isSessionActive) return;
            
            console.log('🚀 Iniciando endSession()...');
            
            isSessionActive = false;
            const sessionDuration = Math.round((Date.now() - sessionStartTime) / 1000 / 60); // en minutos
            
            console.log('⏱️ Duración de sesión calculada:', sessionDuration, 'minutos');
            
            // Actualizar indicador visual
            const indicator = document.getElementById('sessionIndicator');
            if (indicator) {
                indicator.innerHTML = `
                    <i class="fas fa-circle" style="color: #6C757D; margin-right: 0.5rem;"></i>
                    Sesión inactiva - Duración: ${sessionDuration} minutos
                `;
                indicator.style.background = '#F8F9FA';
                indicator.style.color = '#6C757D';
                console.log('✅ Indicador visual actualizado');
            }
            
            // Agregar mensaje de fin de sesión
            console.log('💬 Agregando mensaje de fin de sesión...');
            addMessage('bot', `Sesión finalizada por inactividad. Duración total: ${sessionDuration} minutos. Para continuar, escribe una nueva pregunta.`);
            console.log('✅ Mensaje agregado al chat');
            
            // Registrar fin de sesión
            console.log(`🔚 Sesión finalizada - Duración: ${sessionDuration} minutos`);
            
            // Opcional: Enviar datos de sesión al backend
            logSessionEnd(sessionDuration);
        }

        // Función para iniciar nueva sesión
        function startNewSession() {
            sessionStartTime = Date.now();
            lastActivityTime = Date.now();
            isSessionActive = true;
            
            if (sessionTimer) {
                clearTimeout(sessionTimer);
            }
            sessionTimer = setTimeout(checkSessionTimeout, sessionTimeout);
            
            // Limpiar historial anterior si existe
            if (chatHistory.length > 0) {
                chatHistory = [];
            }
        }

        // Función para registrar fin de sesión (opcional - para analytics)
        function logSessionEnd(duration) {
            // Obtener username del HTML
            const spanElement = document.querySelector('.username');
            const username = spanElement ? spanElement.textContent : 'Usuario Desconocido';
            
            // Obtener todo el chat generado
            const chatWindow = document.getElementById('chatWindow');
            const messages = chatWindow.querySelectorAll('.chat-bubble');
            let chatContent = '';
            
            messages.forEach(message => {
                chatContent += message.textContent + '\n';
            });
            
            const sessionData = {
                username: username,
                startTime: new Date(sessionStartTime).toISOString(),
                duration: duration,
                totalMessages: chatHistory.length,
                totalMessagesVisual: messages.length,
                userAgent: navigator.userAgent,
                chatContent: chatContent.trim()
            };
            
            console.log('📊 Datos de sesión completos:', sessionData);
            
            // Simular envío a API (por ahora solo consola)
            sendSessionDataToAPI(sessionData);
        }

        // Función para enviar datos de sesión a la API
        function sendSessionDataToAPI(sessionData) {
            console.log('🚀 Enviando datos de sesión a la API...');
            
            // Enviar datos a la API real
            fetch('https://backencuestas.avanxadev.com/api/conversacion-bot', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify(sessionData)
            })
            .then(response => {
                if (response.ok) {
                    return response.json();
                } else {
                    throw new Error(`Error HTTP: ${response.status}`);
                }
            })
            .then(data => {
                console.log('✅ Datos enviados exitosamente a la API:', data);
            })
            .catch(error => {
                console.error('❌ Error enviando datos a la API:', error);
                // Opcional: mostrar mensaje de error al usuario
                console.log('⚠️ Los datos de la sesión no se pudieron enviar, pero se guardaron localmente');
            });
        }

        // BASE DE CONOCIMIENTOS LOCAL PARA RESPUESTAS INSTANTÁNEAS
        const BASE_CONOCIMIENTOS = {
            // Medicamentos comunes
            "paracetamol": {
                respuesta: "El **paracetamol** (acetaminofén) es un medicamento analgésico y antipirético muy seguro. Se usa para tratar dolor leve a moderado y fiebre. Es especialmente útil en niños y personas que no pueden tomar AINEs. La dosis recomendada es 500-1000mg cada 4-6 horas, máximo 4g al día, según prescripción médica. Es importante no exceder la dosis máxima para evitar daño hepático.",
                categoria: "Analgésicos"
            },
            "ibuprofeno": {
                respuesta: "El **ibuprofeno** es un antiinflamatorio no esteroideo (AINE) que se usa para tratar dolor, inflamación y fiebre. Es efectivo para dolores musculares, artritis y dolores de cabeza. Se debe tomar con alimentos para evitar irritación gástrica. La dosis típica es 200-400mg cada 4-6 horas, según prescripción médica. No se recomienda en personas con problemas estomacales o renales.",
                categoria: "AINEs"
            },
            "aspirina": {
                respuesta: "La **aspirina** (ácido acetilsalicílico) es un AINE con propiedades analgésicas, antipiréticas y antiinflamatorias. También se usa en dosis bajas para prevenir problemas cardíacos. Es importante tomarla con alimentos y no administrarla a niños menores de 16 años por riesgo de síndrome de Reye. La dosis para dolor es 325-650mg cada 4-6 horas, según prescripción médica.",
                categoria: "AINEs"
            },
            "metformina": {
                respuesta: "La **metformina** es el medicamento de primera línea para la diabetes tipo 2. Actúa reduciendo la producción de glucosa en el hígado y mejorando la sensibilidad a la insulina. Se debe tomar con las comidas para minimizar efectos secundarios gastrointestinales. Los efectos secundarios más comunes son náuseas y diarrea, que suelen mejorar con el tiempo.",
                categoria: "Antidiabéticos"
            },
            "losartan": {
                respuesta: "El **losartán** es un bloqueador del receptor de angiotensina II (BRA) usado para tratar hipertensión arterial. Es bien tolerado y tiene menos efectos secundarios que otros antihipertensivos. Se puede tomar con o sin alimentos. Es importante mantener un control regular de la presión arterial y no suspender el tratamiento sin consultar al médico.",
                categoria: "Antihipertensivos"
            },
            "enalapril": {
                respuesta: "El **enalapril** es un inhibidor de la enzima convertidora de angiotensina (IECA) usado para hipertensión e insuficiencia cardíaca. Un efecto secundario común es la tos seca. Se debe tomar con el estómago vacío para mejor absorción. Es importante evitar el uso durante el embarazo por riesgo de malformaciones fetales.",
                categoria: "Antihipertensivos"
            },
            "amlodipino": {
                respuesta: "El **amlodipino** es un bloqueador de canales de calcio que relaja los vasos sanguíneos para tratar hipertensión y angina. Es de larga duración, por lo que se toma una vez al día. Los efectos secundarios pueden incluir edema en los tobillos y mareos. Es importante tomar la dosis a la misma hora cada día.",
                categoria: "Antihipertensivos"
            },
            "omeprazol": {
                respuesta: "El **omeprazol** es un inhibidor de la bomba de protones que reduce la producción de ácido gástrico. Se usa para tratar úlceras, reflujo gastroesofágico y gastritis. Se debe tomar 30 minutos antes de las comidas para máxima efectividad. El uso prolongado puede afectar la absorción de calcio y vitamina B12.",
                categoria: "Protectores gástricos"
            },
            "insulina": {
                respuesta: "La **insulina** es una hormona esencial para el control de la glucosa en diabetes tipo 1 y algunos casos de tipo 2. Debe almacenarse en refrigerador (2-8°C) y nunca congelarse. La administración debe ser subcutánea, rotando los sitios de inyección. Es crucial mantener un horario regular y monitorear los niveles de glucosa.",
                categoria: "Hormonas"
            },
            "vacunas": {
                respuesta: "Las **vacunas** son medicamentos biológicos que estimulan el sistema inmune para prevenir enfermedades. Requieren almacenamiento en cadena de frío (2-8°C) y nunca deben congelarse. Se aplican por vía intramuscular o subcutánea según la vacuna. Es importante verificar la fecha de vencimiento y mantener registros de vacunación.",
                categoria: "Inmunológicos"
            },
            // Condiciones médicas
            "hipertension": {
                respuesta: "La **hipertensión arterial** es una condición crónica caracterizada por presión arterial elevada (>140/90 mmHg). El tratamiento incluye cambios en el estilo de vida (dieta baja en sodio, ejercicio regular) y medicamentos antihipertensivos. Es importante el control regular de la presión y no suspender la medicación sin indicación médica.",
                categoria: "Enfermedades cardiovasculares"
            },
            "diabetes": {
                respuesta: "La **diabetes** es una enfermedad crónica caracterizada por niveles elevados de glucosa en sangre. La diabetes tipo 2 se puede controlar con dieta, ejercicio y medicamentos orales como metformina. Es fundamental el autocontrol de glucosa, cuidado de los pies y revisiones oftalmológicas regulares para prevenir complicaciones.",
                categoria: "Enfermedades metabólicas"
            },
            "fiebre": {
                respuesta: "La **fiebre** es un aumento de la temperatura corporal (>38°C) que indica que el cuerpo está combatiendo una infección. Se puede tratar con antipiréticos como paracetamol o ibuprofeno. Es importante mantener hidratación adecuada y buscar atención médica si la fiebre persiste más de 3 días o es muy alta (>40°C).",
                categoria: "Síntomas"
            },
            "dolor": {
                respuesta: "El **dolor** es una sensación desagradable que indica daño o enfermedad. Para dolor leve se usan analgésicos como paracetamol. Para dolor inflamatorio se prefieren AINEs como ibuprofeno. Es importante identificar la causa del dolor y no automedicarse por períodos prolongados sin evaluación médica.",
                categoria: "Síntomas"
            },
            // Conceptos farmacéuticos
            "cadena de frio": {
                respuesta: "La **cadena de frío** es el mantenimiento de productos farmacéuticos (vacunas, insulina) a temperaturas controladas (2-8°C) desde la fabricación hasta la administración. Es fundamental para mantener la eficacia y seguridad de estos medicamentos. Se debe monitorear la temperatura constantemente y registrar en bitácoras.",
                categoria: "Almacenamiento"
            },
            "fefo": {
                respuesta: "**FEFO** significa 'First Expired, First Out' (Primero en vencer, primero en salir). Es un principio fundamental en farmacia que prioriza la salida de productos cuya fecha de caducidad está más próxima. Esto ayuda a prevenir pérdidas por vencimiento y asegura que los pacientes reciban medicamentos con mayor vida útil.",
                categoria: "Gestión de inventario"
            },
            "receta magistral": {
                respuesta: "Una **receta magistral** es una prescripción médica para un medicamento personalizado que se elabora en la farmacia. Tiene validez de 30 días corridos desde su extensión. Solo se puede elaborar en farmacias con recetario magistral autorizado. Es importante verificar la fecha de validez antes de procesarla.",
                categoria: "Legislación farmacéutica"
            },
            "estupefacientes": {
                respuesta: "Los **estupefacientes** son medicamentos con alto potencial de abuso y dependencia, sometidos a controles legales especiales. Su despacho es responsabilidad exclusiva del Químico Farmacéutico (Director Técnico), quien debe estar presente personalmente. El auxiliar de farmacia no puede despachar estos medicamentos.",
                categoria: "Legislación farmacéutica"
            },
            "fotosensible": {
                respuesta: "Un medicamento **fotosensible** es aquel que se degrada o pierde eficacia cuando se expone a la luz. Debe almacenarse en envases opacos y protegerse de la luz solar directa. Es importante verificar las condiciones de almacenamiento y no exponer estos medicamentos a fuentes de luz intensa.",
                categoria: "Almacenamiento"
            },
            "kitadol": {
                respuesta: "El **kitadol** es un medicamento que contiene paracetamol (acetaminofén) como principio activo. Es un analgésico y antipirético que se usa para tratar dolor leve a moderado y fiebre. Es especialmente útil en niños y personas que no pueden tomar AINEs. La dosis recomendada es 500-1000mg cada 4-6 horas, máximo 4g al día, según prescripción médica. Es importante no exceder la dosis máxima para evitar daño hepático.",
                categoria: "Analgésicos"
            },
            "clonazepam": {
                respuesta: "El **clonazepam** es un medicamento que pertenece al grupo de las **Benzodiazepinas** (N05BA01 según clasificación ATC). Es un ansiolítico, anticonvulsivante y relajante muscular. Se usa principalmente para tratar trastornos de ansiedad, epilepsia, síndrome de piernas inquietas y trastornos del sueño. NO pertenece al grupo de Psicoanalépticos, sino que es un depresor del sistema nervioso central. Su uso debe ser supervisado por un médico debido al riesgo de dependencia y efectos secundarios como somnolencia y mareos.",
                categoria: "Benzodiazepinas"
            }
        };



        // Función para detectar comparaciones entre medicamentos
        function detectarComparacion(pregunta) {
            const preguntaLimpia = pregunta.toLowerCase();
            
            // Patrones de comparación
            const patronesComparacion = [
                /diferencia|diferencias/,
                /comparar|comparación/,
                /vs|versus/,
                /entre\s+\w+\s+y\s+\w+/,
                /cuál\s+es\s+la\s+diferencia/,
                /qué\s+diferencia\s+hay/
            ];
            
            for (const patron of patronesComparacion) {
                if (patron.test(preguntaLimpia)) {
                    return true;
                }
            }
            return false;
        }

        // Función para generar comparación entre medicamentos
        function generarComparacion(medicamento1, medicamento2) {
            const info1 = BASE_CONOCIMIENTOS[medicamento1];
            const info2 = BASE_CONOCIMIENTOS[medicamento2];
            
            if (!info1 || !info2) {
                return null;
            }
            
            return `**Comparación entre ${medicamento1} y ${medicamento2}:**\n\n` +
                   `**${medicamento1}:**\n` +
                   `- Categoría: ${info1.categoria}\n` +
                   `- ${info1.respuesta.split('.')[0]}.\n\n` +
                   `**${medicamento2}:**\n` +
                   `- Categoría: ${info2.categoria}\n` +
                   `- ${info2.respuesta.split('.')[0]}.\n\n` +
                   `**Principales diferencias:**\n` +
                   `• ${medicamento1} es de la categoría ${info1.categoria}\n` +
                   `• ${medicamento2} es de la categoría ${info2.categoria}\n` +
                   `• Ambos tienen usos y efectos secundarios diferentes`;
        }

        // Función para buscar respuesta local
        function buscarRespuestaLocal(pregunta) {
            // Limpiar la pregunta: quitar signos de interrogación, puntos, comas, etc.
            let preguntaLimpia = pregunta.toLowerCase()
                .replace(/[¿?.,;:!]/g, '')  // Quitar signos de puntuación
                .replace(/\s+/g, ' ')        // Normalizar espacios
                .trim();                     // Quitar espacios al inicio/final
            
            console.log('🔍 Pregunta original:', pregunta);
            console.log('🧹 Pregunta limpia:', preguntaLimpia);
            
            // Verificar si es una comparación
            if (detectarComparacion(pregunta)) {
                console.log('🔍 Comparación detectada');
                
                // Buscar medicamentos en la pregunta
                const medicamentosEncontrados = [];
                for (const [medicamento, info] of Object.entries(BASE_CONOCIMIENTOS)) {
                    if (preguntaLimpia.includes(medicamento)) {
                        medicamentosEncontrados.push(medicamento);
                    }
                }
                
                // Si hay al menos 2 medicamentos, generar comparación
                if (medicamentosEncontrados.length >= 2) {
                    const comparacion = generarComparacion(medicamentosEncontrados[0], medicamentosEncontrados[1]);
                    if (comparacion) {
                        return {
                            respuesta: comparacion,
                            categoria: "Comparación de medicamentos",
                            fuente: "Base de conocimientos local"
                        };
                    }
                }
            }
            
            // Buscar coincidencias exactas primero
            for (const [palabra, info] of Object.entries(BASE_CONOCIMIENTOS)) {
                if (preguntaLimpia.includes(palabra)) {
                    console.log('✅ Coincidencia exacta encontrada:', palabra);
                    return {
                        respuesta: info.respuesta,
                        categoria: info.categoria,
                        fuente: "Base de conocimientos local"
                    };
                }
            }
            
            // Buscar coincidencias parciales más inteligentes
            for (const [palabra, info] of Object.entries(BASE_CONOCIMIENTOS)) {
                // Si la palabra clave está en la pregunta
                if (preguntaLimpia.includes(palabra)) {
                    console.log('✅ Coincidencia parcial encontrada:', palabra);
                    return {
                        respuesta: info.respuesta,
                        categoria: info.categoria,
                        fuente: "Base de conocimientos local"
                    };
                }
                
                // Si la pregunta está en la palabra clave (para preguntas muy cortas)
                if (palabra.includes(preguntaLimpia) && preguntaLimpia.length >= 3) {
                    console.log('✅ Coincidencia inversa encontrada:', palabra);
                    return {
                        respuesta: info.respuesta,
                        categoria: info.categoria,
                        fuente: "Base de conocimientos local"
                    };
                }
            }
            
            // Buscar palabras similares (para errores de escritura comunes)
            const palabrasSimilares = {
                'paracetamol': ['paracetamol', 'acetaminofen', 'acetaminofén', 'tylenol', 'kitadol'],
                'ibuprofeno': ['ibuprofeno', 'ibuprofene', 'advil', 'motrin'],
                'aspirina': ['aspirina', 'aspirin', 'acido acetilsalicilico', 'ácido acetilsalicílico'],
                'hipertension': ['hipertension', 'hipertensión', 'presion alta', 'presión alta', 'tension alta', 'tensión alta'],
                'diabetes': ['diabetes', 'diabetis', 'azucar alta', 'azúcar alta', 'glucosa alta'],
                'fiebre': ['fiebre', 'fiebre', 'temperatura alta', 'calor'],
                'dolor': ['dolor', 'dolores', 'molestia', 'molestias'],
                'cadena de frio': ['cadena de frio', 'cadena de frío', 'cadena frio', 'cadena frío', 'refrigeracion', 'refrigeración'],
                'fefo': ['fefo', 'fifo', 'primero vence', 'primero caduca'],
                'receta magistral': ['receta magistral', 'receta magistral', 'formula magistral', 'fórmula magistral'],
                'estupefacientes': ['estupefacientes', 'estupefacientes', 'narcoticos', 'narcóticos', 'controlados'],
                'fotosensible': ['fotosensible', 'fotosensible', 'sensible luz', 'sensible a la luz']
            };
            
            for (const [palabraClave, variantes] of Object.entries(palabrasSimilares)) {
                for (const variante of variantes) {
                    if (preguntaLimpia.includes(variante)) {
                        console.log('✅ Coincidencia por variante encontrada:', palabraClave, 'via', variante);
                        const info = BASE_CONOCIMIENTOS[palabraClave];
                        return {
                            respuesta: info.respuesta,
                            categoria: info.categoria,
                            fuente: "Base de conocimientos local"
                        };
                    }
                }
            }
            
            console.log('❌ No se encontraron coincidencias');
            return null;
        }

        // Función para enviar pregunta (con respuestas locales + API de respaldo)
        async function sendQuestion() {
            const input = document.getElementById('questionInput');
            const question = input.value.trim();
            
            if (!question) {
                showError('Por favor, escribe una pregunta válida.');
                return;
            }

            // Actualizar actividad del usuario
            updateUserActivity();
            
            // Si es la primera pregunta después de una sesión inactiva, iniciar nueva sesión
            if (!isSessionActive) {
                startNewSession();
            }

            console.log('=== INICIO DE ENVÍO DE PREGUNTA ===');
            console.log('Pregunta a enviar:', question);

            // Agregar pregunta del usuario al chat
            addMessage('user', question);
            
            // Buscar respuesta local primero
            const respuestaLocal = buscarRespuestaLocal(question);
            
            if (respuestaLocal) {
                // Respuesta local encontrada - instantánea
                console.log('✅ Respuesta local encontrada');
                addMessage('bot', respuestaLocal.respuesta);
                input.value = '';
                return;
            }
            
            // Si no hay respuesta local, usar API externa
            console.log('🔍 No se encontró respuesta local, usando API externa...');
            const loadingMessage = addMessage('bot', 'El asistente está escribiendo...');
            
            try {
                const API_URL = 'https://asistente-auxiliar-farmacia.onrender.com';
                console.log('🔗 Intentando conectar a:', API_URL);
                
                const response = await fetch(`${API_URL}/preguntar`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    mode: 'cors',
                    body: JSON.stringify({
                        pregunta: question
                    })
                });
                
                if (!response.ok) {
                    throw new Error(`Error en la respuesta del servidor: ${response.status}`);
                }
                
                const data = await response.json();
                console.log('✅ Respuesta de API recibida');
                
                loadingMessage.remove();
                addMessage('bot', data.respuesta);
                
            } catch (error) {
                console.error('❌ Error en API externa:', error);
                loadingMessage.remove();
                addMessage('bot', 'No encontré una respuesta específica para tu pregunta en mi base de conocimientos local, y la API externa no está disponible. Te sugiero reformular tu pregunta o consultar directamente con tu tutor.');
            }
            
            input.value = '';
            console.log('=== FIN DE ENVÍO DE PREGUNTA ===');
        }

        // Función para verificar y agregar advertencia de dosis
        function verificarDosis(content) {
            // Patrones para detectar dosis (mg, ml, mcg, g, etc.)
            const patronesDosis = [
                /\d+\s*mg/gi,           // 500mg, 500 mg
                /\d+\s*ml/gi,           // 10ml, 10 ml
                /\d+\s*mcg/gi,          // 100mcg, 100 mcg
                /\d+\s*g/gi,            // 4g, 4 g
                /\d+\s*UI/gi,           // 1000UI, 1000 UI
                /\d+\s*mEq/gi,          // 20mEq, 20 mEq
                /\d+\s*mg\/kg/gi,       // 10mg/kg, 10 mg/kg
                /\d+\s*mg\/ml/gi,       // 50mg/ml, 50 mg/ml
                /\d+\s*mg\/día/gi,      // 4g/día, 4 g/día
                /\d+\s*mg\/dosis/gi,    // 500mg/dosis, 500 mg/dosis
                /\d+\s*mg\/hora/gi,     // 100mg/hora, 100 mg/hora
                /\d+\s*mg\/semana/gi,   // 1000mg/semana, 1000 mg/semana
                /\d+\s*mg\/mes/gi       // 500mg/mes, 500 mg/mes
            ];
            
            // Verificar si el contenido contiene dosis
            let contieneDosis = false;
            for (const patron of patronesDosis) {
                if (patron.test(content)) {
                    contieneDosis = true;
                    break;
                }
            }
            
            // Si contiene dosis y no tiene la advertencia, agregarla
            if (contieneDosis && !content.includes('según prescripción médica') && !content.includes('prescripción médica')) {
                // Buscar el final de la oración que contiene la dosis
                const oraciones = content.split('.');
                let contenidoModificado = '';
                
                for (let i = 0; i < oraciones.length; i++) {
                    let oracion = oraciones[i];
                    
                    // Verificar si esta oración contiene dosis
                    let oracionContieneDosis = false;
                    for (const patron of patronesDosis) {
                        if (patron.test(oracion)) {
                            oracionContieneDosis = true;
                            break;
                        }
                    }
                    
                    // Si la oración contiene dosis, agregar la advertencia
                    if (oracionContieneDosis && !oracion.includes('según prescripción médica')) {
                        // Agregar la advertencia al final de la oración
                        if (oracion.trim().endsWith('')) {
                            oracion = oracion.trim() + ' según prescripción médica.';
                        } else {
                            oracion = oracion.trim() + ' según prescripción médica.';
                        }
                    }
                    
                    contenidoModificado += oracion + (i < oraciones.length - 1 ? '. ' : '');
                }
                
                return contenidoModificado;
            }
            
            return content;
        }

        // Función para agregar mensaje al chat
        function addMessage(type, content) {
            const chatWindow = document.getElementById('chatWindow');
            const messageDiv = document.createElement('div');
            messageDiv.className = 'chat-message';
            
            if (type === 'user') {
                // Mensaje del usuario (alineado a la izquierda)
                messageDiv.style.justifyContent = 'flex-start';
                messageDiv.innerHTML = `
                    <div class="chat-bubble user-bubble" style="background: #E8F5E8; color: #2C3E50; margin-left: 0; margin-right: auto;">
                        <strong>Tú:</strong> ${content}
                    </div>
                `;
                
                // Agregar al historial del chat
                chatHistory.push({
                    type: 'user',
                    content: content,
                    timestamp: new Date().toISOString()
                });
            } else {
                // Mensaje del bot (alineado a la derecha)
                const isLoadingMessage = content.includes('está escribiendo');
                const bubbleClass = isLoadingMessage ? 'chat-bubble loading-message' : 'chat-bubble';
                
                // Verificar y modificar contenido si contiene dosis
                const contenidoVerificado = verificarDosis(content);
                
                messageDiv.innerHTML = `
                    <div class="${bubbleClass}">
                        <strong>NEXO:</strong> ${contenidoVerificado}
                    </div>
                `;
                
                // Agregar al historial del chat (solo si no es mensaje de carga)
                if (!isLoadingMessage) {
                    chatHistory.push({
                        type: 'bot',
                        content: contenidoVerificado,
                        timestamp: new Date().toISOString()
                    });
                }
            }
            
            chatWindow.appendChild(messageDiv);
            chatWindow.scrollTop = chatWindow.scrollHeight;
            return messageDiv; // Retornar el elemento para poder eliminarlo después
        }

        // Función para limpiar el chat
        function clearChat() {
            const chatWindow = document.getElementById('chatWindow');
            chatWindow.innerHTML = `
                <div class="chat-message">
                    <div class="chat-bubble">
                        <strong>NEXO:</strong> ¡Hola! Soy NEXO tu asistente virtual. ¿En qué puedo ayudarte hoy con respecto al curso de Auxiliar de Farmacia y sus manuales?
                    </div>
                </div>
            `;
            isFirstQuestion = true; // Resetear la variable para la siguiente pregunta
            
            // Limpiar historial del chat
            chatHistory = [];
            console.log('🧹 Historial del chat limpiado');
        }

        // Función para exportar el chat
        function exportChat() {
            const chatWindow = document.getElementById('chatWindow');
            const messages = chatWindow.querySelectorAll('.chat-bubble');
            let chatText = 'Conversación con NEXO - Asistente Virtual de Farmacia\n';
            chatText += 'Fecha: ' + new Date().toLocaleString() + '\n\n';
            
            messages.forEach(message => {
                chatText += message.textContent + '\n\n';
            });
            
            const blob = new Blob([chatText], { type: 'text/plain' });
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'chat_farmacia_' + new Date().toISOString().slice(0,10) + '.txt';
            a.click();
            window.URL.revokeObjectURL(url);
        }





        // Función para recargar casos clínicos
        function refreshCases() {
            if (confirm('¿Deseas recargar los casos clínicos?')) {
                location.reload();
            }
        }

        // Función para mezclar casos clínicos
        function shuffleCases() {
            if (confirm('¿Deseas mezclar el orden de los casos clínicos?')) {
                // Mezclar el array de casos clínicos
                for (let i = CASOS_CLINICOS.casos_clinicos.length - 1; i > 0; i--) {
                    const j = Math.floor(Math.random() * (i + 1));
                    [CASOS_CLINICOS.casos_clinicos[i], CASOS_CLINICOS.casos_clinicos[j]] = 
                    [CASOS_CLINICOS.casos_clinicos[j], CASOS_CLINICOS.casos_clinicos[i]];
                }
                console.log('✅ Casos clínicos mezclados correctamente.');
            }
        }

        // Función para mostrar errores
        function showError(message) {
            const errorDiv = document.createElement('div');
            errorDiv.style.cssText = `
                background: #F44336;
                color: white;
                padding: 1rem;
                border-radius: 8px;
                margin: 1rem 0;
                text-align: center;
            `;
            errorDiv.textContent = message;
            document.querySelector('.chat-interface').insertBefore(errorDiv, document.querySelector('.chat-input-container'));
            
            setTimeout(() => {
                errorDiv.remove();
            }, 5000);
        }

        // Función para iniciar casos clínicos
        function startCasosClinicos() {
            console.log('🚀 Iniciando casos clínicos...');
            
            casosClinicos = CASOS_CLINICOS.casos_clinicos;
            casoActual = 0;
            preguntaActual = 0;
            puntajeCasosClinicos = 0;
            totalPreguntasCasosClinicos = casosClinicos.reduce((total, caso) => total + caso.preguntas.length, 0);
            quizAnswered = false; // Resetear estado de respuesta
            
            console.log(`✅ Casos clínicos iniciados con ${casosClinicos.length} casos y ${totalPreguntasCasosClinicos} preguntas`);
            console.log('📊 Variables inicializadas:', {
                casosClinicos: casosClinicos.length,
                casoActual,
                preguntaActual,
                puntajeCasosClinicos,
                totalPreguntasCasosClinicos,
                quizAnswered
            });
            
            // Ocultar secciones principales y mostrar quiz
            document.querySelector('.assistant-intro').style.display = 'none';
            document.querySelector('.chat-interface').style.display = 'none';
            document.querySelector('.clinical-cases-section').style.display = 'none';
            document.getElementById('quizContent').style.display = 'block';
            
            console.log('🔄 Llamando a showCasoClinico...');
            showCasoClinico();
        }

        // Función para mostrar caso clínico
        function showCasoClinico() {
            const quizContent = document.getElementById('quizContent');
            
            if (casoActual >= casosClinicos.length) {
                // Mostrar resultados finales
                const porcentaje = Math.round((puntajeCasosClinicos / totalPreguntasCasosClinicos) * 100);
                let mensaje = '';
                if (porcentaje >= 90) {
                    mensaje = '¡Excelente! 🏆 Dominas los casos clínicos';
                } else if (porcentaje >= 70) {
                    mensaje = '¡Muy bien! 👍 Buen manejo de casos clínicos';
                } else if (porcentaje >= 50) {
                    mensaje = '¡Bien! 💪 Puedes mejorar en casos clínicos';
                } else {
                    mensaje = 'Necesitas repasar más 📚 los casos clínicos';
                }
                
                quizContent.innerHTML = `
                    <div class="quiz-question">¡Evaluación de Casos Clínicos Finalizada!</div>
                    <div class="success">
                        <h3>${mensaje}</h3>
                        <p>Tu puntaje: <b>${puntajeCasosClinicos} / ${totalPreguntasCasosClinicos}</b> (${porcentaje}%)</p>
                        <div class="progress-bar">
                            <div class="progress-fill" style="width: ${porcentaje}%"></div>
                        </div>
                        <p style="margin-top: 1rem; font-size: 0.9rem;">
                            📊 <strong>Resumen:</strong><br>
                            • Casos completados: ${casosClinicos.length}<br>
                            • Preguntas respondidas: ${totalPreguntasCasosClinicos}<br>
                            • Respuestas correctas: ${puntajeCasosClinicos}
                        </p>
                    </div>
                    <div style="text-align: center; margin-top: 2rem;">
                        <button class="btn" onclick="startCasosClinicos()" style="margin-right: 1rem;">🔄 Reiniciar</button>
                        <button class="btn" onclick="resetQuizSection()">🏠 Volver al Menú</button>
                    </div>
                `;
                return;
            }
            
            const caso = casosClinicos[casoActual];
            const pregunta = caso.preguntas[preguntaActual];
            
            // Calcular progreso general
            let preguntasCompletadas = 0;
            for (let i = 0; i < casoActual; i++) {
                preguntasCompletadas += casosClinicos[i].preguntas.length;
            }
            preguntasCompletadas += preguntaActual;
            const progreso = (preguntasCompletadas / totalPreguntasCasosClinicos) * 100;
            
            // Calcular número de pregunta correlativo en todo el test
            let preguntaCorrelativa = 1;
            for (let i = 0; i < casoActual; i++) {
                preguntaCorrelativa += casosClinicos[i].preguntas.length;
            }
            preguntaCorrelativa += preguntaActual;
            
            quizContent.innerHTML = `
                <div class="caso-clinico">
                    <div class="caso-titulo">${caso.titulo}</div>
                    <div class="caso-descripcion">${caso.descripcion}</div>
                </div>
                
                                    <div class="caso-info">
                        <div class="caso-numeros">
                            <div class="caso-numero">
                                <strong>Pregunta ${preguntaCorrelativa} de ${totalPreguntasCasosClinicos}</strong><br>
                                <span style="font-size: 0.9rem; opacity: 0.8;">
                                    Caso Clínico N° ${casoActual + 1} - Pregunta ${preguntaActual + 1} de ${caso.preguntas.length}
                                </span>
                            </div>
                        </div>
                        <div class="puntaje-actual">Puntaje actual: ${puntajeCasosClinicos} punto${puntajeCasosClinicos !== 1 ? 's' : ''}</div>
                    </div>
                
                <div class="quiz-question">${pregunta.pregunta}</div>
                <div class="quiz-options">
                    ${pregunta.opciones.map((opcion, index) => `
                        <div class="quiz-option" onclick="selectOptionCasoClinico(this, ${index})">
                            ${opcion}
                        </div>
                    `).join('')}
                </div>
                <div style="display: flex; gap: 1rem; align-items: center; margin-top: 1rem;">
                    <button class="btn" onclick="checkAnswerCasoClinico()" id="checkBtn" disabled>Responder</button>
                    <button class="btn-back-to-chat" onclick="resetQuizSection()" style="margin: 0;">
                        Volver al Chat
                    </button>
                </div>
            `;
        }

        // Función para seleccionar opción
        function selectOptionCasoClinico(element, optionIndex) {
            console.log('🔍 Función selectOptionCasoClinico ejecutada');
            console.log('Elemento:', element);
            console.log('Índice de opción:', optionIndex);
            console.log('quizAnswered:', quizAnswered);
            
            if (quizAnswered) {
                console.log('❌ Quiz ya respondido, no se puede seleccionar');
                return;
            }
            
            // Remover selección anterior
            document.querySelectorAll('.quiz-option').forEach(opt => {
                opt.classList.remove('selected');
            });
            
            // Agregar selección nueva
            element.classList.add('selected');
            console.log('✅ Opción seleccionada:', element.textContent);
            
            // Habilitar botón de responder
            const checkBtn = document.getElementById('checkBtn');
            if (checkBtn) {
                checkBtn.disabled = false;
                console.log('✅ Botón de responder habilitado');
            } else {
                console.log('❌ No se encontró el botón de responder');
            }
        }

        // Función para verificar respuesta
        function checkAnswerCasoClinico() {
            if (quizAnswered) return;
            
            const selected = document.querySelector('.quiz-option.selected');
            if (!selected) return;
            
            const selectedIndex = Array.from(document.querySelectorAll('.quiz-option')).indexOf(selected);
            const caso = casosClinicos[casoActual];
            const pregunta = caso.preguntas[preguntaActual];
            
            quizAnswered = true;
            
            // Marcar opciones correctas e incorrectas
            document.querySelectorAll('.quiz-option').forEach((option, index) => {
                if (index === pregunta.respuesta_correcta) {
                    option.classList.add('correct');
                } else if (index === selectedIndex && index !== pregunta.respuesta_correcta) {
                    option.classList.add('incorrect');
                }
            });
            
            let result, resultClass;
            if (selectedIndex === pregunta.respuesta_correcta) {
                puntajeCasosClinicos++;
                result = '¡Correcto! 🎉';
                resultClass = 'success';
            } else {
                result = `Incorrecto. La respuesta correcta es: ${pregunta.opciones[pregunta.respuesta_correcta]}`;
                resultClass = 'error';
            }
            
            const resultDiv = document.createElement('div');
            resultDiv.className = resultClass;
            resultDiv.innerHTML = `
                <div>${result}</div>
                <div style="margin-top: 0.5rem; font-size: 0.9rem; opacity: 0.9;">
                    <strong>Explicación:</strong> ${pregunta.explicacion}
                </div>
            `;
            document.getElementById('quizContent').appendChild(resultDiv);
            document.getElementById('checkBtn').disabled = true;
            
            // Esperar 1 segundo antes de mostrar el botón de siguiente
            setTimeout(() => {
                const nextBtn = document.createElement('button');
                nextBtn.className = 'btn-siguiente-pregunta';
                nextBtn.style.marginLeft = '1rem';
                nextBtn.style.marginTop = '1rem';
                
                if (preguntaActual < caso.preguntas.length - 1) {
                    // Siguiente pregunta del mismo caso
                    nextBtn.innerHTML = 'Siguiente pregunta <i class="fas fa-chevron-right"></i>';
                    nextBtn.onclick = () => {
                        preguntaActual++;
                        quizAnswered = false;
                        showCasoClinico();
                    };
                } else if (casoActual < casosClinicos.length - 1) {
                    // Siguiente caso
                    nextBtn.innerHTML = 'Siguiente pregunta <i class="fas fa-chevron-right"></i>';
                    nextBtn.onclick = () => {
                        casoActual++;
                        preguntaActual = 0;
                        quizAnswered = false;
                        showCasoClinico();
                    };
                } else {
                    // Finalizar
                    nextBtn.innerHTML = 'Finalizar evaluación <i class="fas fa-chevron-right"></i>';
                    nextBtn.onclick = () => {
                        casoActual++;
                        showCasoClinico();
                    };
                }
                document.getElementById('quizContent').appendChild(nextBtn);
            }, 1000);
        }

        // Función para resetear la sección
        function resetQuizSection() {
            // NO resetear el progreso de casos clínicos - mantener donde quedó el alumno
            // Ocultar quiz y mostrar contenido inicial
            document.getElementById('quizContent').style.display = 'none';
            document.querySelector('.assistant-intro').style.display = 'block';
            document.querySelector('.chat-interface').style.display = 'block';
            document.querySelector('.clinical-cases-section').style.display = 'block';
            isFirstQuestion = true; // Resetear solo la variable del chat
        }

        // Inicialización al cargar la página
        window.onload = function() {
            console.log('🚀 LMS - Página cargada correctamente');
            console.log('🔗 API URL configurada:', 'https://asistente-auxiliar-farmacia.onrender.com');
            console.log('✅ Estilos de quiz corregidos - Visualización de selección activada');
            console.log('✅ Botón "Volver al Chat" agregado en casos clínicos');
            console.log('✅ Logo eliminado del frontend');
            
            // Solo resetear la variable del chat, NO las de casos clínicos
            isFirstQuestion = true;
            
            console.log('🔄 Variable del chat reseteada al cargar la página');
            console.log('📊 Estado inicial del chat:', { isFirstQuestion });
            
            // Verificar que las secciones estén visibles
            const clinicalSection = document.querySelector('.clinical-cases-section');
            const startButton = document.querySelector('.btn-start-practice');
            
            console.log('🔍 Verificando sección de casos clínicos:');
            console.log('- Sección encontrada:', clinicalSection);
            console.log('- Botón encontrado:', startButton);
            console.log('- Display de la sección:', clinicalSection ? clinicalSection.style.display : 'No encontrada');
            console.log('- Display del botón:', startButton ? startButton.style.display : 'No encontrado');
            
            // Iniciar tracking de sesión
            startNewSession();
            
            // Agregar event listeners para detectar actividad del usuario
            setupActivityTracking();
            
            // Iniciar timer visual que se actualiza cada segundo
            setInterval(updateSessionTimer, 1000);
            
            // La página ya está lista para usar
        };

        // Función para configurar tracking de actividad
        function setupActivityTracking() {
            // NO configurar eventos de mouse/teclado - solo preguntas resetean el timer
            console.log('🔧 Tracking configurado: Solo preguntas resetean el timer');
            
            // Detectar cuando el usuario sale de la página
            document.addEventListener('visibilitychange', function() {
                if (document.hidden) {
                    console.log('👁️ Usuario cambió de pestaña o minimizó ventana');
                }
                // NO resetear timer al volver a la pestaña
            });
            
            // Detectar cuando el usuario sale de la página
            window.addEventListener('beforeunload', function() {
                if (isSessionActive) {
                    endSession();
                }
            });
            
            console.log('✅ Tracking de actividad configurado (solo preguntas)');
        }
    </script>
</body>
</html> 