<!DOCTYPE html>
<!-- Última actualización: 2024-12-19 15:30 - Forzar actualización LMS -->
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Asistente Virtual de Farmacia - Avanxa - VERSION ACTUALIZADA 15:30</title>
    <style>
        :root {
            --color-primario: #4B2067;
            --color-secundario: #7C3FAF;
            --color-acento: #FF6B35;
            --color-texto: #2C3E50;
            --color-fondo: #F8F9FA;
            --color-rojo: #FF0000;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: #F8F9FA;
            min-height: 100vh;
            color: var(--color-texto);
            line-height: 1.6;
        }

        .container {
            max-width: 1000px;
            margin: 0 auto;
            padding: 20px;
        }

        /* Sección del Asistente Virtual */
        .assistant-intro {
            background: white;
            border-radius: 12px;
            padding: 2rem;
            margin-bottom: 2rem;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            border: 1px solid #E9ECEF;
        }

        .assistant-intro p {
            font-size: 1.1rem;
            color: var(--color-texto);
            text-align: center;
            margin-bottom: 0;
        }

        /* Chat Interface */
        .chat-interface {
            background: white;
            border-radius: 12px;
            padding: 2rem;
            margin-bottom: 2rem;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            border: 1px solid #E9ECEF;
        }

        .chat-window {
            background: #F8F9FA;
            border-radius: 12px;
            padding: 1.5rem;
            border: 1px solid #E9ECEF;
            min-height: 200px;
            margin-bottom: 1.5rem;
            position: relative;
        }

        .chat-message {
            display: flex;
            justify-content: flex-end;
            margin-bottom: 1rem;
        }

        .chat-bubble {
            background: var(--color-secundario);
            color: white;
            padding: 1rem 1.5rem;
            border-radius: 20px;
            max-width: 70%;
            position: relative;
            margin-left: auto;
        }

        .chat-bubble::before {
            content: '';
            position: absolute;
            right: -10px;
            top: 50%;
            transform: translateY(-50%);
            width: 0;
            height: 0;
            border-left: 10px solid var(--color-secundario);
            border-top: 8px solid transparent;
            border-bottom: 8px solid transparent;
        }

        .chat-bubble.user-bubble::before {
            right: auto;
            left: -10px;
            border-left: none;
            border-right: 10px solid #E8F5E8;
        }

        .chat-input-container {
            display: flex;
            gap: 1rem;
            align-items: center;
        }

        .chat-input-field {
            flex: 1;
            padding: 1rem 1.5rem;
            border: 1px solid #E9ECEF;
            border-radius: 25px;
            font-size: 16px;
            background: white;
        }

        .chat-input-field:focus {
            outline: none;
            border-color: var(--color-secundario);
        }

        .btn-send {
            background: var(--color-primario);
            color: white;
            border: none;
            border-radius: 25px;
            padding: 1rem 2rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .btn-send:hover {
            background: var(--color-secundario);
        }

        .chat-actions {
            display: flex;
            gap: 0.5rem;
        }

        .btn-action {
            background: none;
            border: none;
            padding: 0.5rem;
            cursor: pointer;
            border-radius: 50%;
            transition: background 0.3s ease;
        }

        .btn-action:hover {
            background: #E9ECEF;
        }

        .btn-action i {
            font-size: 1.2rem;
            color: #666;
        }

        /* Sección de Casos Clínicos */
        .clinical-cases-section {
            background: white;
            border-radius: 12px;
            padding: 2rem;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            border: 1px solid #E9ECEF;
        }

        .case-header {
            display: flex;
            align-items: center;
            margin-bottom: 1.5rem;
        }

        .case-icon {
            background: var(--color-rojo);
            color: white;
            width: 40px;
            height: 40px;
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.5rem;
            font-weight: bold;
            margin-right: 1rem;
        }

        .case-title {
            font-size: 1.5rem;
            font-weight: 600;
            color: var(--color-texto);
        }

        .case-description {
            color: var(--color-texto);
            margin-bottom: 2rem;
            line-height: 1.7;
        }

        .btn-start-practice {
            background: var(--color-primario);
            color: white;
            border: none;
            border-radius: 8px;
            padding: 1rem 2rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            margin-right: 1rem;
        }

        .btn-start-practice:hover {
            background: var(--color-secundario);
        }

        .case-actions {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .case-controls {
            display: flex;
            gap: 0.5rem;
        }

        .btn-control {
            background: none;
            border: none;
            padding: 0.5rem;
            cursor: pointer;
            border-radius: 50%;
            transition: background 0.3s ease;
        }

        .btn-control:hover {
            background: #E9ECEF;
        }

        .btn-control i {
            font-size: 1.2rem;
            color: #666;
        }

        /* Responsive */
        @media (max-width: 768px) {
            .container {
                padding: 10px;
            }
            
            .chat-input-container {
                flex-direction: column;
                gap: 0.5rem;
            }
            
            .chat-actions {
                justify-content: center;
            }
            
            .case-actions {
                flex-direction: column;
                gap: 1rem;
                align-items: stretch;
            }
        }
    </style>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
</head>
<body>
    <div class="container">
        <!-- Sección del Asistente Virtual -->
        <div class="assistant-intro">
            <p>¡Hola! Soy XXXXXXXXX, tu Asistente Virtual de Farmacia. Estoy aquí para ayudarte con tus dudas sobre el curso de Auxiliar de Farmacia. Puedes escribirme cualquier pregunta o elegir una de las sugerencias que aparecen más abajo. ¡Comencemos!</p>
        </div>

        <!-- Interfaz de Chat -->
        <div class="chat-interface">
            <div class="chat-window" id="chatWindow">
                <div class="chat-message">
                    <div class="chat-bubble">
                        <strong>Asistente educativo:</strong> ¡Hola! ¿En qué puedo ayudarte hoy?
                    </div>
                </div>
            </div>
            
            <div class="chat-input-container">
                <button class="btn-send" onclick="sendQuestion()" id="sendBtn">Enviar</button>
                <input type="text" id="questionInput" class="chat-input-field" placeholder="Escribe tu pregunta aquí" onkeypress="handleKeyPress(event)">
                <div class="chat-actions">
                    <button class="btn-action" onclick="clearChat()" title="Limpiar chat">
                        <i class="fas fa-trash"></i>
                    </button>
                    <button class="btn-action" onclick="exportChat()" title="Exportar chat">
                        <i class="fas fa-file-export"></i>
                    </button>
                </div>
            </div>
        </div>

        <!-- Sección de Casos Clínicos -->
        <div class="clinical-cases-section">
            <div class="case-header">
                <div class="case-icon">+</div>
                <div class="case-title">Practica con Casos Clínicos</div>
            </div>
            
            <div class="case-description">
                ¡Prepárate para tu examen con casos clínicos reales! Practica en un entorno seguro y sin repercusiones negativas, diseñado para ayudarte a ensayar y reforzar tus conocimientos. Esta herramienta te permitirá familiarizarte con el tipo de preguntas que podrías enfrentar en el examen de competencia ante la SEREMI de Salud. ¡Aumenta tu confianza y asegura tu éxito!
            </div>
            
            <div class="case-actions">
                <button class="btn-start-practice" onclick="startCasosClinicos()">Iniciar Practica</button>
                <div class="case-controls">
                    <button class="btn-control" onclick="refreshCases()" title="Recargar">
                        <i class="fas fa-redo"></i>
                    </button>
                    <button class="btn-control" onclick="shuffleCases()" title="Mezclar">
                        <i class="fas fa-random"></i>
                    </button>
                </div>
            </div>
        </div>

        <!-- Contenido de Casos Clínicos (oculto inicialmente) -->
        <div id="quizContent" style="display: none;"></div>
    </div>

    <script>
        // CASOS CLÍNICOS INTEGRADOS DIRECTAMENTE - TODOS LOS CASOS
        const CASOS_CLINICOS = {
            "casos_clinicos": [
                {
                    "id": 1,
                    "titulo": "Caso Clínico: Paciente con Hipertensión",
                    "descripcion": "María, 65 años, acude a la farmacia con una receta médica para tratar su hipertensión arterial. Presenta presión arterial de 160/95 mmHg y tiene antecedentes de diabetes tipo 2.",
                    "preguntas": [
                        {
                            "id": 1,
                            "pregunta": "¿Cuál de los siguientes medicamentos NO es un antihipertensivo de primera línea?",
                            "opciones": [
                                "A) Losartán",
                                "B) Amlodipino", 
                                "C) Paracetamol",
                                "D) Enalapril"
                            ],
                            "respuesta_correcta": 2,
                            "explicacion": "El paracetamol es un analgésico y antipirético, no un antihipertensivo. Los otros tres son medicamentos antihipertensivos comunes."
                        },
                        {
                            "id": 2,
                            "pregunta": "¿Qué precaución especial debe tener María al tomar antihipertensivos?",
                            "opciones": [
                                "A) Tomar con el estómago lleno",
                                "B) Evitar cambios bruscos de posición",
                                "C) Exponerse al sol sin protección",
                                "D) Hacer ejercicio intenso inmediatamente"
                            ],
                            "respuesta_correcta": 1,
                            "explicacion": "Los antihipertensivos pueden causar hipotensión ortostática, por lo que se debe evitar levantarse bruscamente."
                        },
                        {
                            "id": 3,
                            "pregunta": "¿Cuál es el valor normal de presión arterial para adultos?",
                            "opciones": [
                                "A) 140/90 mmHg",
                                "B) 120/80 mmHg",
                                "C) 160/100 mmHg", 
                                "D) 180/110 mmHg"
                            ],
                            "respuesta_correcta": 1,
                            "explicacion": "El valor normal de presión arterial es menor a 120/80 mmHg."
                        },
                        {
                            "id": 4,
                            "pregunta": "¿Qué efecto secundario es común en los inhibidores de la ECA?",
                            "opciones": [
                                "A) Tos seca",
                                "B) Diarrea",
                                "C) Insomnio",
                                "D) Pérdida de apetito"
                            ],
                            "respuesta_correcta": 0,
                            "explicacion": "La tos seca es un efecto secundario frecuente de los inhibidores de la ECA como el enalapril."
                        },
                        {
                            "id": 5,
                            "pregunta": "¿Qué recomendación dietética es importante para María?",
                            "opciones": [
                                "A) Aumentar el consumo de sal",
                                "B) Reducir el consumo de sodio",
                                "C) Consumir más grasas saturadas",
                                "D) Evitar las verduras"
                            ],
                            "respuesta_correcta": 1,
                            "explicacion": "La reducción del consumo de sodio es fundamental en el tratamiento de la hipertensión arterial."
                        }
                    ]
                },
                {
                    "id": 2,
                    "titulo": "Caso Clínico: Paciente con Diabetes",
                    "descripcion": "Carlos, 45 años, diagnosticado recientemente con diabetes tipo 2. Acude a la farmacia para recibir orientación sobre su medicación y cuidados generales.",
                    "preguntas": [
                        {
                            "id": 1,
                            "pregunta": "¿Cuál es el objetivo principal del tratamiento de la diabetes tipo 2?",
                            "opciones": [
                                "A) Curar la enfermedad",
                                "B) Mantener niveles normales de glucosa",
                                "C) Eliminar la insulina del cuerpo",
                                "D) Reducir el peso corporal únicamente"
                            ],
                            "respuesta_correcta": 1,
                            "explicacion": "El objetivo principal es mantener niveles normales de glucosa en sangre para prevenir complicaciones."
                        },
                        {
                            "id": 2,
                            "pregunta": "¿Qué medicamento oral es de primera línea para la diabetes tipo 2?",
                            "opciones": [
                                "A) Insulina",
                                "B) Metformina",
                                "C) Glibenclamida",
                                "D) Pioglitazona"
                            ],
                            "respuesta_correcta": 1,
                            "explicacion": "La metformina es el medicamento de primera línea para el tratamiento de la diabetes tipo 2."
                        },
                        {
                            "id": 3,
                            "pregunta": "¿Cuál es el valor normal de glucosa en ayunas?",
                            "opciones": [
                                "A) 70-100 mg/dL",
                                "B) 100-126 mg/dL",
                                "C) 126-200 mg/dL",
                                "D) Más de 200 mg/dL"
                            ],
                            "respuesta_correcta": 0,
                            "explicacion": "Los valores normales de glucosa en ayunas son entre 70-100 mg/dL."
                        },
                        {
                            "id": 4,
                            "pregunta": "¿Qué complicación es más frecuente en pacientes diabéticos?",
                            "opciones": [
                                "A) Problemas cardíacos",
                                "B) Problemas renales",
                                "C) Problemas oculares",
                                "D) Todas las anteriores"
                            ],
                            "respuesta_correcta": 3,
                            "explicacion": "La diabetes puede afectar múltiples órganos, siendo frecuentes las complicaciones cardíacas, renales y oculares."
                        },
                        {
                            "id": 5,
                            "pregunta": "¿Qué recomendación es importante para el autocontrol de la diabetes?",
                            "opciones": [
                                "A) Medir glucosa solo cuando se sienta mal",
                                "B) Realizar controles regulares de glucosa",
                                "C) No medir nunca la glucosa",
                                "D) Medir solo una vez al mes"
                            ],
                            "respuesta_correcta": 1,
                            "explicacion": "El autocontrol regular de la glucosa es fundamental para el manejo adecuado de la diabetes."
                        }
                    ]
                },
                {
                    "id": 3,
                    "titulo": "Caso Clínico: Paciente con Dolor Crónico",
                    "descripcion": "Ana, 58 años, padece artritis reumatoide y acude a la farmacia con dolor crónico en las articulaciones. Toma medicamentos antiinflamatorios regularmente.",
                    "preguntas": [
                        {
                            "id": 1,
                            "pregunta": "¿Qué tipo de medicamento es más apropiado para el dolor crónico de Ana?",
                            "opciones": [
                                "A) Paracetamol",
                                "B) Ibuprofeno",
                                "C) Morfina",
                                "D) Aspirina"
                            ],
                            "respuesta_correcta": 1,
                            "explicacion": "Los antiinflamatorios no esteroideos como el ibuprofeno son apropiados para el dolor inflamatorio crónico."
                        },
                        {
                            "id": 2,
                            "pregunta": "¿Qué efecto secundario es común en los AINEs?",
                            "opciones": [
                                "A) Problemas gastrointestinales",
                                "B) Somnolencia",
                                "C) Pérdida de memoria",
                                "D) Visión borrosa"
                            ],
                            "respuesta_correcta": 0,
                            "explicacion": "Los AINEs pueden causar irritación gástrica y úlceras, por lo que deben tomarse con alimentos."
                        },

                        {
                            "id": 3,
                            "pregunta": "¿Qué recomendación es importante para Ana?",
                            "opciones": [
                                "A) Tomar medicamentos con el estómago vacío",
                                "B) Tomar medicamentos con alimentos",
                                "C) No hacer ejercicio",
                                "D) Evitar el reposo"
                            ],
                            "respuesta_correcta": 1,
                            "explicacion": "Los AINEs deben tomarse con alimentos para reducir la irritación gástrica."
                        },
                        {
                            "id": 4,
                            "pregunta": "¿Qué terapia complementaria puede ayudar a Ana?",
                            "opciones": [
                                "A) Fisioterapia",
                                "B) Acupuntura",
                                "C) Ejercicio moderado",
                                "D) Todas las anteriores"
                            ],
                            "respuesta_correcta": 3,
                            "explicacion": "Todas estas terapias complementarias pueden ayudar en el manejo del dolor crónico."
                        }
                    ]
                },
                {
                    "id": 4,
                    "titulo": "Caso Clínico: Paciente Pediátrico",
                    "descripcion": "Lucas, 8 años, presenta fiebre de 38.5°C y dolor de garganta. Su madre acude a la farmacia buscando orientación sobre el tratamiento adecuado.",
                    "preguntas": [
                        {
                            "id": 1,
                            "pregunta": "¿Qué medicamento es seguro para la fiebre en niños?",
                            "opciones": [
                                "A) Aspirina",
                                "B) Paracetamol",
                                "C) Ibuprofeno",
                                "D) B y C son correctas"
                            ],
                            "respuesta_correcta": 3,
                            "explicacion": "Tanto el paracetamol como el ibuprofeno son seguros para niños, pero nunca aspirina por riesgo de síndrome de Reye."
                        },

                        {
                            "id": 2,
                            "pregunta": "¿Cuándo se debe derivar al médico un niño con fiebre?",
                            "opciones": [
                                "A) Siempre que tenga fiebre",
                                "B) Si la fiebre persiste más de 3 días",
                                "C) Solo si la fiebre es muy alta",
                                "D) Nunca es necesario"
                            ],
                            "respuesta_correcta": 1,
                            "explicacion": "Se debe derivar al médico si la fiebre persiste más de 3 días o si hay otros síntomas preocupantes."
                        },
                        {
                            "id": 3,
                            "pregunta": "¿Qué medida no farmacológica es útil para la fiebre?",
                            "opciones": [
                                "A) Baños con agua fría",
                                "B) Baños con agua tibia",
                                "C) Abrigar mucho al niño",
                                "D) No dar líquidos"
                            ],
                            "respuesta_correcta": 1,
                            "explicacion": "Los baños con agua tibia ayudan a bajar la fiebre de forma segura."
                        },
                        {
                            "id": 4,
                            "pregunta": "¿Qué es importante verificar antes de administrar medicamentos a niños?",
                            "opciones": [
                                "A) Solo el peso",
                                "B) Solo la edad",
                                "C) Peso, edad y antecedentes alérgicos",
                                "D) Solo si tiene hambre"
                            ],
                            "respuesta_correcta": 2,
                            "explicacion": "Es fundamental verificar peso, edad y antecedentes alérgicos antes de administrar medicamentos a niños."
                        }
                    ]
                },
                {
                    "id": 5,
                    "titulo": "Caso Clínico: Gestión de Almacenamiento de Vacunas e Insulina",
                    "descripcion": "Un auxiliar de farmacia recibe un nuevo lote de vacunas y jeringas precargadas de insulina. Estos productos requieren condiciones especiales de almacenamiento para mantener su calidad y eficacia.",
                    "preguntas": [
                        {
                            "id": 1,
                            "pregunta": "Considerando el vencimiento y la necesidad de cadena de frío, ¿cuál de las siguientes combinaciones de principio de gestión de existencias y rango de temperatura es la más adecuada para estos productos?",
                            "opciones": [
                                "A) FIFO (First In, First Out) a 15-25°C",
                                "B) LIFO (Last In, First Out) a 8-15°C", 
                                "C) FEFO (First Expired, First Out) a 2-8°C",
                                "D) FSN (Fast, Slow, Non-moving) a menos de 0°C"
                            ],
                            "respuesta_correcta": 2,
                            "explicacion": "La alternativa correcta es c) FEFO (First Expired, First Out) a 2-8°C. El principio FEFO, acrónimo en inglés de \"First Expired, First Out\", es fundamental para el auxiliar de farmacia y rige la norma 147. Este principio prioriza la salida de los productos cuya fecha de caducidad está más próxima, independientemente del lote, lo cual ayuda a prevenir pérdidas por vencimiento. Tanto las vacunas como las insulinas son productos que requieren mantener una cadena de frío estricta, lo que significa que deben conservarse a una temperatura entre 2 y 8°C. Es importante recordar que la insulina NUNCA debe ser congelada."
                        }
                    ]
                },
                {
                    "id": 6,
                    "titulo": "Caso Clínico: Cálculo Posológico - Ácido Valproico Gotas",
                    "descripcion": "Un paciente acude a la farmacia con una receta para Ácido Valproico Gotas. La indicación médica es \"administrar 23 gotas cada 12 horas por 3 meses\". La farmacia solo dispone de Ácido Valproico en una presentación de frascos de 25 mL, y se sabe que 20 gotas equivalen a 1 mL.",
                    "preguntas": [
                        {
                            "id": 1,
                            "pregunta": "¿Cuántos frascos de 25 mL de Ácido Valproico Gotas debería dispensar el auxiliar de farmacia para cubrir el tratamiento completo de este paciente?",
                            "opciones": [
                                "A) 8 frascos",
                                "B) 9 frascos",
                                "C) 10 frascos", 
                                "D) 4 frascos"
                            ],
                            "respuesta_correcta": 1,
                            "explicacion": "La alternativa correcta es b) 9 frascos. Para determinar la cantidad de frascos a dispensar, se realizan los siguientes cálculos posológicos: 1. Calcular la dosis diaria en gotas: La indicación \"cada 12 horas\" implica 2 administraciones al día (24 horas / 12 horas = 2). Por lo tanto, 23 gotas * 2 veces al día = 46 gotas diarias. 2. Calcular el total de gotas para el tratamiento: El tratamiento es por 3 meses, lo que se considera como 90 días. Entonces, 46 gotas/día * 90 días = 4.140 gotas necesarias para el tratamiento. 3. Determinar cuántas gotas contiene un frasco de 25 mL: Sabiendo que 20 gotas equivalen a 1 mL, un frasco de 25 mL contiene 25 mL * 20 gotas/mL = 500 gotas por frasco. 4. Calcular el número de frascos necesarios: Se divide el total de gotas requeridas por el número de gotas por frasco: 4.140 gotas / 500 gotas/frasco = 8,28 frascos. 5. Dado que no es posible dispensar frascos fraccionados y se debe asegurar la indemnidad del producto terminado y el cumplimiento completo del tratamiento, se debe redondear al entero superior. Por lo tanto, el auxiliar deberá dispensar 9 frascos al paciente."
                        }
                    ]
                },
                {
                    "id": 7,
                    "titulo": "Caso Clínico: Despacho de Medicamentos Estupefacientes",
                    "descripcion": "Un paciente presenta una receta para un medicamento clasificado como estupefaciente. En ese momento, el Químico Farmacéutico (Director Técnico) no se encuentra en el establecimiento, y el Auxiliar de Farmacia es el único personal presente con autorización para despachar otros tipos de recetas y manejar el abastecimiento.",
                    "preguntas": [
                        {
                            "id": 1,
                            "pregunta": "Según el Reglamento 466, ¿cuál es la acción correcta que debe tomar el Auxiliar de Farmacia en esta situación?",
                            "opciones": [
                                "A) Despachar la receta, haciendo constar su nombre y firma, ya que tiene autorización sanitaria para el despacho de productos farmacéuticos en general.",
                                "B) Negarse a despachar la receta y pedir al paciente que espere al Químico Farmacéutico, ya que el despacho de este tipo de medicamentos es una responsabilidad exclusiva de este último.",
                                "C) Informar al paciente que la farmacia no comercializa este tipo de medicamentos controlados.",
                                "D) Despachar la receta si cuenta con una autorización escrita del Químico Farmacéutico para acceder al área de control de stock."
                            ],
                            "respuesta_correcta": 1,
                            "explicacion": "La alternativa correcta es b) Negarse a despachar la receta y pedir al paciente que espere al Químico Farmacéutico, ya que el despacho de este tipo de medicamentos es una responsabilidad exclusiva de este último. El Reglamento 466 establece claramente que es responsabilidad del Químico Farmacéutico (Director Técnico) despachar personalmente las recetas de productos farmacéuticos sometidos a controles legales especiales, como estupefacientes y psicotrópicos, dejando constancia de su nombre y firma. Aunque el auxiliar de farmacia tiene responsabilidades en el despacho y manejo de productos farmacéuticos bajo la supervisión del director técnico, la función específica de despacho personal de sustancias controladas es atribuida al Químico Farmacéutico. El acceso al área de control de stock de estos productos está restringido al director técnico o personal autorizado por escrito por él, pero esto no delega la obligación de \"despacho personal\" del Químico Farmacéutico."
                        }
                    ]
                },
                {
                    "id": 8,
                    "titulo": "Caso Clínico: Validez de Recetas Magistrales",
                    "descripcion": "Un paciente acude a una farmacia que cuenta con recetario magistral, presentando una receta para una fórmula magistral (una crema tópica personalizada) que fue extendida por su médico hace 40 días. El auxiliar de farmacia debe verificar la validez de la receta antes de procesarla para su elaboración.",
                    "preguntas": [
                        {
                            "id": 1,
                            "pregunta": "¿Cuál es el estado de la receta magistral presentada por el paciente, según la normativa vigente?",
                            "opciones": [
                                "A) Es válida, ya que las recetas magistrales, al ser personalizadas, no tienen un plazo de caducidad estricto.",
                                "B) Es válida, siempre y cuando el médico revalide la fecha en la farmacia mediante un nuevo documento o firma.",
                                "C) No es válida, pues ha excedido el plazo legal de 30 días corridos desde su extensión.",
                                "D) Es válida si el auxiliar de farmacia, tras evaluar al paciente, considera que el tratamiento sigue siendo pertinente."
                            ],
                            "respuesta_correcta": 2,
                            "explicacion": "La alternativa correcta es c) No es válida, pues ha excedido el plazo legal de 30 días corridos desde su extensión. Los documentos indican que \"El plazo durante el cual una receta es válida para ser presentada a su elaboración en recetario es de 30 días corridos contados desde la fecha de su extensión\". Una vez superado este plazo, la receta pierde su validez para ser elaborada en el recetario, independientemente de la necesidad clínica o la valoración del auxiliar."
                        }
                    ]
                },
                {
                    "id": 9,
                    "titulo": "Caso Clínico: Almacenamiento de Medicamentos Fotosensibles",
                    "descripcion": "El auxiliar de farmacia Pablo está realizando una revisión de las condiciones de almacenamiento en la sala de ventas. Observa que varios envases de medicamentos fotosensibles (que deben protegerse de la luz) están ubicados cerca de un ventanal donde reciben luz solar directa durante varias horas al día. Adicionalmente, Pablo nota que los termómetros de máxima y mínima no se han registrado por escrito en los últimos cinco días en las distintas áreas de almacenamiento.",
                    "preguntas": [
                        {
                            "id": 1,
                            "pregunta": "¿Cuál de los siguientes factores de almacenamiento representa un riesgo inmediato para la calidad de los medicamentos fotosensibles observados y qué acción se requiere con respecto a la temperatura?",
                            "opciones": [
                                "A) La humedad, ya que promueve el crecimiento de bacterias y hongos en el producto.",
                                "B) La temperatura, aunque los medicamentos fotosensibles no se ven directamente afectados por ella.",
                                "C) La luz, que puede degradar los medicamentos, y el registro constante (al menos dos veces al día) y por escrito de la temperatura es obligatorio en todas las áreas de almacenamiento.",
                                "D) La falta de segregación física de los productos, que puede llevar a contaminación cruzada."
                            ],
                            "respuesta_correcta": 2,
                            "explicacion": "La alternativa correcta es c) La luz, que puede degradar los medicamentos, y el registro constante (al menos dos veces al día) y por escrito de la temperatura es obligatorio en todas las áreas de almacenamiento."
                        }
                    ]
                }
            ]
        };

        // Variables globales para casos clínicos
        let casosClinicos = [];
        let casoActual = 0;
        let preguntaActual = 0;
        let puntajeCasosClinicos = 0;
        let totalPreguntasCasosClinicos = 0;
        let quizAnswered = false;

        // Función para manejar Enter en el input
        function handleKeyPress(event) {
            if (event.key === 'Enter') {
                sendQuestion();
            }
        }

        // Función para enviar pregunta (conectada con backend)
        async function sendQuestion() {
            const input = document.getElementById('questionInput');
            const question = input.value.trim();
            
            if (!question) {
                showError('Por favor, escribe una pregunta válida.');
                return;
            }

            console.log('=== INICIO DE ENVÍO DE PREGUNTA ===');
            console.log('Pregunta a enviar:', question);

            // Agregar pregunta del usuario al chat
            addMessage('user', question);
            
            // Mostrar mensaje de carga
            const loadingMessage = addMessage('bot', '🤖 El asistente está escribiendo...');
            
            try {
                // Conectar con tu API FastAPI
                const API_URL = 'https://asistente-auxiliar-farmacia.onrender.com';
                console.log('🔗 Intentando conectar a:', API_URL);
                console.log('📝 Pregunta a enviar:', question);
                
                // Primero probar si la API está disponible
                console.log('🧪 Probando conexión básica...');
                const testResponse = await fetch(`${API_URL}/`, {
                    method: 'GET',
                    mode: 'cors'
                });
                console.log('✅ Test response status:', testResponse.status);
                
                console.log('📤 Enviando pregunta al endpoint /preguntar...');
                const response = await fetch(`${API_URL}/preguntar`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    mode: 'cors',
                    body: JSON.stringify({
                        pregunta: question
                    })
                });
                
                console.log('📥 Response status:', response.status);
                console.log('📥 Response headers:', response.headers);
                
                if (!response.ok) {
                    throw new Error(`Error en la respuesta del servidor: ${response.status}`);
                }
                
                const data = await response.json();
                console.log('✅ Response data recibida:', data);
                console.log('✅ Respuesta del bot:', data.respuesta);
                
                // Remover mensaje de carga y mostrar respuesta real
                loadingMessage.remove();
                addMessage('bot', data.respuesta);
                console.log('✅ Mensaje del bot agregado al chat');
                
            } catch (error) {
                console.error('❌ Error detallado:', error);
                console.error('❌ Error message:', error.message);
                console.error('❌ Error stack:', error.stack);
                loadingMessage.remove();
                addMessage('bot', 'Lo siento, hubo un error al procesar tu pregunta. Por favor, intenta de nuevo.');
                console.log('❌ Mensaje de error mostrado al usuario');
            }
            
            input.value = '';
            console.log('=== FIN DE ENVÍO DE PREGUNTA ===');
        }

        // Función para agregar mensaje al chat
        function addMessage(type, content) {
            const chatWindow = document.getElementById('chatWindow');
            const messageDiv = document.createElement('div');
            messageDiv.className = 'chat-message';
            
            if (type === 'user') {
                // Mensaje del usuario (alineado a la izquierda)
                messageDiv.style.justifyContent = 'flex-start';
                messageDiv.innerHTML = `
                    <div class="chat-bubble user-bubble" style="background: #E8F5E8; color: #2C3E50; margin-left: 0; margin-right: auto;">
                        <strong>Tú:</strong> ${content}
                    </div>
                `;
            } else {
                // Mensaje del bot (alineado a la derecha)
                messageDiv.innerHTML = `
                    <div class="chat-bubble">
                        <strong>Asistente educativo:</strong> ${content}
                    </div>
                `;
            }
            
            chatWindow.appendChild(messageDiv);
            chatWindow.scrollTop = chatWindow.scrollHeight;
            return messageDiv; // Retornar el elemento para poder eliminarlo después
        }

        // Función para limpiar el chat
        function clearChat() {
            const chatWindow = document.getElementById('chatWindow');
            chatWindow.innerHTML = `
                <div class="chat-message">
                    <div class="chat-bubble">
                        <strong>Asistente educativo:</strong> ¡Hola! ¿En qué puedo ayudarte hoy?
                    </div>
                </div>
            `;
        }

        // Función para exportar el chat
        function exportChat() {
            const chatWindow = document.getElementById('chatWindow');
            const messages = chatWindow.querySelectorAll('.chat-bubble');
            let chatText = 'Conversación con Asistente Virtual de Farmacia\n';
            chatText += 'Fecha: ' + new Date().toLocaleString() + '\n\n';
            
            messages.forEach(message => {
                chatText += message.textContent + '\n\n';
            });
            
            const blob = new Blob([chatText], { type: 'text/plain' });
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'chat_farmacia_' + new Date().toISOString().slice(0,10) + '.txt';
            a.click();
            window.URL.revokeObjectURL(url);
        }

        // Función para recargar casos clínicos
        function refreshCases() {
            if (confirm('¿Deseas recargar los casos clínicos?')) {
                location.reload();
            }
        }

        // Función para mezclar casos clínicos
        function shuffleCases() {
            if (confirm('¿Deseas mezclar el orden de los casos clínicos?')) {
                // Mezclar el array de casos clínicos
                for (let i = CASOS_CLINICOS.casos_clinicos.length - 1; i > 0; i--) {
                    const j = Math.floor(Math.random() * (i + 1));
                    [CASOS_CLINICOS.casos_clinicos[i], CASOS_CLINICOS.casos_clinicos[j]] = 
                    [CASOS_CLINICOS.casos_clinicos[j], CASOS_CLINICOS.casos_clinicos[i]];
                }
                alert('Casos clínicos mezclados correctamente.');
            }
        }

        // Función para mostrar errores
        function showError(message) {
            const errorDiv = document.createElement('div');
            errorDiv.style.cssText = `
                background: #F44336;
                color: white;
                padding: 1rem;
                border-radius: 8px;
                margin: 1rem 0;
                text-align: center;
            `;
            errorDiv.textContent = message;
            document.querySelector('.chat-interface').insertBefore(errorDiv, document.querySelector('.chat-input-container'));
            
            setTimeout(() => {
                errorDiv.remove();
            }, 5000);
        }

        // Función para iniciar casos clínicos
        function startCasosClinicos() {
            console.log('🚀 Iniciando casos clínicos...');
            
            casosClinicos = CASOS_CLINICOS.casos_clinicos;
            casoActual = 0;
            preguntaActual = 0;
            puntajeCasosClinicos = 0;
            totalPreguntasCasosClinicos = casosClinicos.reduce((total, caso) => total + caso.preguntas.length, 0);
            quizAnswered = false; // Resetear estado de respuesta
            
            console.log(`✅ Casos clínicos iniciados con ${casosClinicos.length} casos y ${totalPreguntasCasosClinicos} preguntas`);
            console.log('📊 Variables inicializadas:', {
                casosClinicos: casosClinicos.length,
                casoActual,
                preguntaActual,
                puntajeCasosClinicos,
                totalPreguntasCasosClinicos,
                quizAnswered
            });
            
            // Ocultar secciones principales y mostrar quiz
            document.querySelector('.assistant-intro').style.display = 'none';
            document.querySelector('.chat-interface').style.display = 'none';
            document.querySelector('.clinical-cases-section').style.display = 'none';
            document.getElementById('quizContent').style.display = 'block';
            
            console.log('🔄 Llamando a showCasoClinico...');
            showCasoClinico();
        }

        // Función para mostrar caso clínico
        function showCasoClinico() {
            const quizContent = document.getElementById('quizContent');
            
            if (casoActual >= casosClinicos.length) {
                // Mostrar resultados finales
                const porcentaje = Math.round((puntajeCasosClinicos / totalPreguntasCasosClinicos) * 100);
                let mensaje = '';
                if (porcentaje >= 90) {
                    mensaje = '¡Excelente! 🏆 Dominas los casos clínicos';
                } else if (porcentaje >= 70) {
                    mensaje = '¡Muy bien! 👍 Buen manejo de casos clínicos';
                } else if (porcentaje >= 50) {
                    mensaje = '¡Bien! 💪 Puedes mejorar en casos clínicos';
                } else {
                    mensaje = 'Necesitas repasar más 📚 los casos clínicos';
                }
                
                quizContent.innerHTML = `
                    <div class="quiz-question">¡Evaluación de Casos Clínicos Finalizada!</div>
                    <div class="success">
                        <h3>${mensaje}</h3>
                        <p>Tu puntaje: <b>${puntajeCasosClinicos} / ${totalPreguntasCasosClinicos}</b> (${porcentaje}%)</p>
                        <div class="progress-bar">
                            <div class="progress-fill" style="width: ${porcentaje}%"></div>
                        </div>
                        <p style="margin-top: 1rem; font-size: 0.9rem;">
                            📊 <strong>Resumen:</strong><br>
                            • Casos completados: ${casosClinicos.length}<br>
                            • Preguntas respondidas: ${totalPreguntasCasosClinicos}<br>
                            • Respuestas correctas: ${puntajeCasosClinicos}
                        </p>
                    </div>
                    <div style="text-align: center; margin-top: 2rem;">
                        <button class="btn" onclick="startCasosClinicos()" style="margin-right: 1rem;">🔄 Reiniciar</button>
                        <button class="btn" onclick="resetQuizSection()">🏠 Volver al Menú</button>
                    </div>
                `;
                return;
            }
            
            const caso = casosClinicos[casoActual];
            const pregunta = caso.preguntas[preguntaActual];
            
            // Calcular progreso general
            let preguntasCompletadas = 0;
            for (let i = 0; i < casoActual; i++) {
                preguntasCompletadas += casosClinicos[i].preguntas.length;
            }
            preguntasCompletadas += preguntaActual;
            const progreso = (preguntasCompletadas / totalPreguntasCasosClinicos) * 100;
            
            quizContent.innerHTML = `
                <div class="caso-clinico">
                    <div class="caso-titulo">${caso.titulo}</div>
                    <div class="caso-descripcion">${caso.descripcion}</div>
                </div>
                
                <div class="quiz-progress">
                    <div class="progress-text">
                        Caso ${casoActual + 1} de ${casosClinicos.length} - 
                        Pregunta ${preguntaActual + 1} de ${caso.preguntas.length}
                    </div>
                    <div class="progress-bar">
                        <div class="progress-fill" style="width: ${progreso}%"></div>
                    </div>
                    <div class="score-display">Puntaje actual: ${puntajeCasosClinicos}</div>
                </div>
                
                <div class="quiz-question">${pregunta.pregunta}</div>
                <div class="quiz-options">
                    ${pregunta.opciones.map((opcion, index) => `
                        <div class="quiz-option" onclick="selectOptionCasoClinico(this, ${index})">
                            ${opcion}
                        </div>
                    `).join('')}
                </div>
                <button class="btn" onclick="checkAnswerCasoClinico()" id="checkBtn" disabled>Responder</button>
            `;
        }

        // Función para seleccionar opción
        function selectOptionCasoClinico(element, optionIndex) {
            console.log('🔍 Función selectOptionCasoClinico ejecutada');
            console.log('Elemento:', element);
            console.log('Índice de opción:', optionIndex);
            console.log('quizAnswered:', quizAnswered);
            
            if (quizAnswered) {
                console.log('❌ Quiz ya respondido, no se puede seleccionar');
                return;
            }
            
            // Remover selección anterior
            document.querySelectorAll('.quiz-option').forEach(opt => {
                opt.classList.remove('selected');
            });
            
            // Agregar selección nueva
            element.classList.add('selected');
            console.log('✅ Opción seleccionada:', element.textContent);
            
            // Habilitar botón de responder
            const checkBtn = document.getElementById('checkBtn');
            if (checkBtn) {
                checkBtn.disabled = false;
                console.log('✅ Botón de responder habilitado');
            } else {
                console.log('❌ No se encontró el botón de responder');
            }
        }

        // Función para verificar respuesta
        function checkAnswerCasoClinico() {
            if (quizAnswered) return;
            
            const selected = document.querySelector('.quiz-option.selected');
            if (!selected) return;
            
            const selectedIndex = Array.from(document.querySelectorAll('.quiz-option')).indexOf(selected);
            const caso = casosClinicos[casoActual];
            const pregunta = caso.preguntas[preguntaActual];
            
            quizAnswered = true;
            
            // Marcar opciones correctas e incorrectas
            document.querySelectorAll('.quiz-option').forEach((option, index) => {
                if (index === pregunta.respuesta_correcta) {
                    option.classList.add('correct');
                } else if (index === selectedIndex && index !== pregunta.respuesta_correcta) {
                    option.classList.add('incorrect');
                }
            });
            
            let result, resultClass;
            if (selectedIndex === pregunta.respuesta_correcta) {
                puntajeCasosClinicos++;
                result = '¡Correcto! 🎉';
                resultClass = 'success';
            } else {
                result = `Incorrecto. La respuesta correcta es: ${pregunta.opciones[pregunta.respuesta_correcta]}`;
                resultClass = 'error';
            }
            
            const resultDiv = document.createElement('div');
            resultDiv.className = resultClass;
            resultDiv.innerHTML = `
                <div>${result}</div>
                <div style="margin-top: 0.5rem; font-size: 0.9rem; opacity: 0.9;">
                    <strong>Explicación:</strong> ${pregunta.explicacion}
                </div>
            `;
            document.getElementById('quizContent').appendChild(resultDiv);
            document.getElementById('checkBtn').disabled = true;
            
            // Esperar 3 segundos antes de mostrar el botón de siguiente
            setTimeout(() => {
                const nextBtn = document.createElement('button');
                nextBtn.className = 'btn';
                nextBtn.style.marginLeft = '1rem';
                nextBtn.style.marginTop = '1rem';
                
                if (preguntaActual < caso.preguntas.length - 1) {
                    // Siguiente pregunta del mismo caso
                    nextBtn.textContent = 'Siguiente pregunta ➡️';
                    nextBtn.onclick = () => {
                        preguntaActual++;
                        quizAnswered = false;
                        showCasoClinico();
                    };
                } else if (casoActual < casosClinicos.length - 1) {
                    // Siguiente caso
                    nextBtn.textContent = 'Siguiente caso ➡️';
                    nextBtn.onclick = () => {
                        casoActual++;
                        preguntaActual = 0;
                        quizAnswered = false;
                        showCasoClinico();
                    };
                } else {
                    // Finalizar
                    nextBtn.textContent = 'Finalizar evaluación 🏁';
                    nextBtn.onclick = () => {
                        casoActual++;
                        showCasoClinico();
                    };
                }
                document.getElementById('quizContent').appendChild(nextBtn);
            }, 3000);
        }

        // Función para resetear la sección
        function resetQuizSection() {
            // Ocultar quiz y mostrar contenido inicial
            document.getElementById('quizContent').style.display = 'none';
            document.querySelector('.assistant-intro').style.display = 'block';
            document.querySelector('.chat-interface').style.display = 'block';
            document.querySelector('.clinical-cases-section').style.display = 'block';
        }

            // Inicialización al cargar la página
    window.onload = function() {
        alert('🚀 VERSIÓN ACTUALIZADA 15:30 - Si ves este mensaje, el LMS está cargando el archivo correcto');
        console.log('🚀 LMS - Página cargada correctamente - Versión actualizada 15:30');
        console.log('🔗 API URL configurada:', 'https://asistente-auxiliar-farmacia.onrender.com');
        // La página ya está lista para usar
    };
    </script>
</body>
</html> 